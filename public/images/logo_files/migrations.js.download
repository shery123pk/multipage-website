(function(){'use strict';function asyncPipeline(){for(var _len=arguments.length,fns=new Array(_len),_key=0;_key<_len;_key++){fns[_key]=arguments[_key];}
return arg=>{return fns.reduce((acc,fn)=>{return acc.then(fn);},Promise.resolve(arg));};}
function updateVersion(version){return options=>{return{...options,currentVersion:version};};}
function migrate(options,opts){let fns=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[];if(options.currentVersion===options.targetVersion){return options;}
if(options.currentVersion!==opts.migrateFrom){return options;}
return asyncPipeline(...fns,updateVersion(opts.migrateTo))(options);}
let count=0;const generateId=()=>String(new Date().getTime()+count++);const createResource=(mediaUrl,type)=>{const id=generateId();return{id,resource:{id,source:'picsart',location:mediaUrl,type}};};let V4SendMessage=function(V4SendMessage){V4SendMessage["select"]="select";V4SendMessage["apply"]="apply-res";return V4SendMessage;}({});let V4ReceiveMessage=function(V4ReceiveMessage){V4ReceiveMessage["apply"]="apply";V4ReceiveMessage["configs"]="configs";V4ReceiveMessage["interaction"]="interaction";V4ReceiveMessage["bootstrapEditing"]="bootstrap-editing";V4ReceiveMessage["bootstrapContent"]="bootstrap-content";V4ReceiveMessage["bootstrapPublishing"]="bootstrap-publishing";return V4ReceiveMessage;}({});let ReceiveMessages=function(ReceiveMessages){ReceiveMessages["close"]="close";ReceiveMessages["bootstrap"]="bootstrap";ReceiveMessages["deactivate"]="deactivate";ReceiveMessages["customEvent"]="custom-event";ReceiveMessages["redirectResponse"]="redirect-res";ReceiveMessages["syncContext"]="sync-context";ReceiveMessages["resolveMessage"]="resolve-message";ReceiveMessages["openFileChooserResponse"]="chooser-res";ReceiveMessages["refreshTokenResponse"]="refresh-token-res";ReceiveMessages["remoteSettingsResponse"]="remote-settings-res";ReceiveMessages["fetchAlbumsResponse"]="fetch-media-albums-res";ReceiveMessages["requestPermissionResponse"]="request-permission-res";ReceiveMessages["fetchMediaAssetsResponse"]="fetch-media-assets-res";ReceiveMessages["generateResultImageResponse"]="generate-result-image-res";ReceiveMessages["syncRequest"]="sync-request";return ReceiveMessages;}({});let SendMessages=function(SendMessages){SendMessages["error"]="error";SendMessages["share"]="share";SendMessages["ready"]="ready";SendMessages["close"]="close-res";SendMessages["notifier"]="notifier";SendMessages["dialog"]="dialog";SendMessages["redirect"]="redirect";SendMessages["navigate"]="navigate";SendMessages["analytics"]="analytics";SendMessages["download"]="download";SendMessages["downloadFile"]="export";SendMessages["saveState"]="save-state";SendMessages["openFileChooser"]="chooser";SendMessages["configureUi"]="configure-ui";SendMessages["syncContext"]="sync-context";SendMessages["refreshToken"]="refresh-token";SendMessages["customEvent"]="custom-event-res";SendMessages["fetchAlbums"]="fetch-media-albums";SendMessages["requestPermission"]="request-permission";SendMessages["getRemoteSettings"]="remote-settings";SendMessages["fetchMediaAssets"]="fetch-media-assets";SendMessages["redirectToPackageId"]="redirect-to-package-id";SendMessages["generateResultImage"]="generate-result-image";SendMessages["resolveMessage"]="resolve-message";return SendMessages;}({});const isBootstrapAction=data=>data.action===ReceiveMessages.bootstrap;const isConfirmAction=data=>data.action===SendMessages.syncContext;const isStickerLayerData=data=>data.type==='sticker';const isReceiveFileChooserResponseAction=data=>data.action===ReceiveMessages.openFileChooserResponse;const isExportFilesAction=data=>data.action===SendMessages.downloadFile;const isOldConfirmAction=data=>data.action===V4SendMessage.apply||data.action===V4SendMessage.select;const isResolvableAction=data=>typeof data.resolveId==='string';const isGenerateResultImageResponseAction=data=>data.action===ReceiveMessages.generateResultImageResponse;const imageUrlToResource=options=>{const{data}=options;if(isConfirmAction(data)){var _data$payload$images;const resources={};(_data$payload$images=data.payload.images)===null||_data$payload$images===void 0||_data$payload$images.forEach(_ref=>{var _data$payload$resourc;let{layer}=_ref;if((_data$payload$resourc=data.payload.resources)!==null&&_data$payload$resourc!==void 0&&_data$payload$resourc[layer.url])return;const{id,resource}=createResource(layer.url,'photo');resources[id]=resource;layer.url=id;});data.payload.resources={...data.payload.resources,...resources};}
return options;};const resourceToImageUrl=options=>{const{data}=options;if(isBootstrapAction(data)||isReceiveFileChooserResponseAction(data)||isConfirmAction(data)){var _data$payload$images;(_data$payload$images=data.payload.images)===null||_data$payload$images===void 0||_data$payload$images.forEach(_ref=>{var _data$payload$resourc;let{layer}=_ref;layer.url=((_data$payload$resourc=data.payload.resources)===null||_data$payload$resourc===void 0?void 0:_data$payload$resourc[layer.url].location)||'';});delete data.payload.resources;}
return options;};const typeMap=new Map([['Content',V4ReceiveMessage.bootstrapContent],['Edit',V4ReceiveMessage.bootstrapEditing],['Publish',V4ReceiveMessage.bootstrapPublishing]]);const receiveMessages$3=options=>{const needToStorePayload=isBootstrapAction(options.data)||isConfirmAction(options.data);const{data:{payload}}=options;if(isBootstrapAction(options.data)){var _options$data$payload;const changeTheVersion=Number(((_options$data$payload=options.data.payload.platformVersion)===null||_options$data$payload===void 0?void 0:_options$data$payload.split('v')[1])||0)<6;options.data.payload={...options.data.payload,platformVersion:changeTheVersion?'v5':options.data.payload.platformVersion,version:changeTheVersion?'v5-v4':options.data.payload.version};options.data.action=typeMap.get(payload.miniapp.extensions[0].type);}
if(isConfirmAction(options.data)){options.data.action=V4ReceiveMessage.configs;}
if(needToStorePayload){window.v5currentPayload=options.data.payload;}
return options;};const sendMessages=options=>{const currentPayload=window.v5currentPayload;const{data}=options;if(isOldConfirmAction(data)){var _data$payload$images,_data$payload$texts;const image=(_data$payload$images=data.payload.images)===null||_data$payload$images===void 0?void 0:_data$payload$images[0];const text=(_data$payload$texts=data.payload.texts)===null||_data$payload$texts===void 0?void 0:_data$payload$texts[0];const selectedLayerId=data.action===DeprecatedSendMessage.apply?currentPayload.selectedLayerIds[0]:generateId();if(image){image.layer.id=image.layer.id||selectedLayerId;}
if(text){text.layer.id=text.layer.id||selectedLayerId;}
data.payload.selectedLayerIds=[...currentPayload.selectedLayerIds];if(data.action===DeprecatedSendMessage.select){data.payload.images=[...currentPayload.images];data.payload.texts=[...currentPayload.texts];if(image){data.payload.images.push(image);}
if(text){data.payload.texts.push(text);}}else{data.payload.images=currentPayload.images.map(item=>{if(image&&item.layer.id===(image===null||image===void 0?void 0:image.layer.id))return{...image,...item,layer:{...item.layer,...image.layer}};return item;});data.payload.texts=currentPayload.texts.map(item=>{if(text&&item.layer.id===(text===null||text===void 0?void 0:text.layer.id))return{...text,...item,layer:{...item.layer,...text.layer}};return item;});}
data.payload.videos=[];data.action=SendMessages.syncContext;}
return options;};const exportFiles$1=options=>{if(isExportFilesAction(options.data)){options.data.payload={...options.data.payload,...(options.data.payload.images||[]).reduce((acc,image)=>{const{id,resource}=createResource(image.layer.url,'photo');acc.images.push({...image,layer:{...image.layer,url:id}});acc.resources[id]=resource;return acc;},{images:[],resources:{}})};}
return options;};const searchParams=new URLSearchParams(window.location.search);const platformQuery=searchParams.get('platform');const noop=()=>{};const channel=new MessageChannel();let nativeJsPortTwo=channel.port2;const nativeJsPortOne=channel.port1;const androidResolver={current:noop};const androidResolvePromise=new Promise(resolve=>{androidResolver.current=resolve;});window.addEventListener('message',event=>{if(event.data==='capturePort'){if(event.ports[0]!==null){nativeJsPortTwo=event.ports[0];androidResolver.current();}}else{try{typeof event.data==='string'&&nativeJsPortOne.postMessage(JSON.parse(event.data));}catch(err){console.log(err);}}});nativeJsPortOne.start();nativeJsPortTwo.start();const normalizedUserAgent=window.navigator.userAgent.toLowerCase();const isAndroidDevice=/android/.test(normalizedUserAgent);const isAndroid=()=>isAndroidDevice&&/; wv\)/.test(normalizedUserAgent);const isWindows=()=>{var _window;return!!((_window=window)!==null&&_window!==void 0&&(_window=_window.chrome)!==null&&_window!==void 0&&_window.webview);};const isIOS=()=>{var _window$webkit;return!!((_window$webkit=window['webkit'])!==null&&_window$webkit!==void 0&&_window$webkit.messageHandlers.bridge);};const isAndroidProtocol=()=>platformQuery==='android'||isAndroid();const isWindowsProtocol=()=>platformQuery==='windows'||isWindows();const isIOSProtocol=()=>platformQuery==='ios'||isIOS();const sendToWeb=data=>window.parent.postMessage(data,'*');const sendToAndroid=async data=>{await androidResolvePromise;nativeJsPortTwo.postMessage(data);};const sendToWindows=data=>window.chrome.webview.postMessage(data);const sendToIos=data=>window['webkit'].messageHandlers.bridge.postMessage(data);const isServerSupported=()=>isIOS()||isAndroid()||isWindows();const isWeb=()=>!isAndroid()&&!isIOS()&&!isWindows();const isWebProtocol=()=>platformQuery==='web'||isWeb();const sendProtocols=['http://','https://','blob:','data:'];const canStoredInLocalServer=url=>isServerSupported()&&sendProtocols.some(protocol=>url.startsWith(protocol));const getExtension=mimeType=>mimeType.split('/')[1];const tcpLimit=6;const scheduledQueue=[];const activeQueue=[];const schedulerCheck=()=>{if(activeQueue.length<=tcpLimit&&scheduledQueue.length){const next=scheduledQueue.shift();if(next){const promise=next();activeQueue.push(promise);promise.then(()=>{activeQueue.splice(activeQueue.indexOf(promise),1);schedulerCheck();});}}};const withScheduler=executor=>{return function(){for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}
return new Promise((resolve,reject)=>{scheduledQueue.push(async()=>{try{const result=await executor(...args);resolve(result);}catch(err){reject(err);}});schedulerCheck();});};};const baseUrl='https://localhost:4000';const setImage=async(filename,file)=>{const formData=new FormData();formData.append('image',file,filename);const response=await fetch("".concat(baseUrl,"/storage"),{method:'POST',body:formData});return response.ok;};var setImage$1=withScheduler(setImage);const urlToLocalServer=async url=>{return fetch(url).then(resp=>resp.blob()).then(async blob=>{const filename="".concat(generateId(),".").concat(getExtension(blob.type));await setImage$1(filename,blob);return filename;});};const absoluteUrlToLocalServer=async options=>{const{data}=options;if(isBootstrapAction(data)){await Promise.all((data.payload.images||[]).map(image=>{const{layer}=image;const promises=[];if(canStoredInLocalServer(layer.url)){promises.push(urlToLocalServer(layer.url).then(localUrl=>layer.url===localUrl));}
if(layer.maskUrl&&canStoredInLocalServer(layer.maskUrl)){promises.push(urlToLocalServer(layer.maskUrl).then(localUrl=>layer.maskUrl===localUrl));}
return Promise.all(promises);}));}
return options;};function runV4ToV5Migrations(options){return migrate(options,{migrateFrom:'v4',migrateTo:'v5'},[sendMessages,exportFiles$1,imageUrlToResource]);}
function runV5ToV4Migrations(options){return migrate(options,{migrateFrom:'v5',migrateTo:'v4'},[resourceToImageUrl,absoluteUrlToLocalServer,receiveMessages$3]);}
const defaultPoint={x:0.5,y:0.5};const defaultFlipped={horizontal:false,vertical:false};const defaultTransform={position:defaultPoint,rotation:0,scale:1,aspect_scale:1,scale_type:'fit',flipped:defaultFlipped,position_space:'self'};const defaultPattern={opacity:0};const defaultMask={manual:false,inverted:false,shapes:[]};const defaultStroke={pattern:defaultPattern,width:0,linecap:'butt',linejoin:'round'};const defaultImageLayerParams={photo:'',transform:defaultTransform,opacity:100,blendmode:'normal',stroke:defaultStroke};const defaultStickerParams={sticker:'',transform:defaultTransform,opacity:100,blendmode:'normal',stroke:defaultStroke};const defaultTextLayerParams={text:'',lines:[],alignment:'center',letter_spacing:1,line_spacing:1,bend:0,fill:defaultPattern,opacity:100,transform:defaultTransform,blendmode:'normal',format:[],perspective_points:[]};function isV5Sticker(image){const currentPayload=window.v6CurrentPayload||{};if(currentPayload.stickers){return currentPayload.stickers.some(sticker=>sticker.uuid===image.layer.id);}else{return false;}}
function toReplayV2(options){var _options$data$payload,_options$data$payload2,_options$data$payload3,_options$data$payload5;if(!isConfirmAction(options.data))return options;const currentPayload=window.v6CurrentPayload||{};const images=[];const stickers=[];(_options$data$payload=options.data.payload.images)===null||_options$data$payload===void 0||_options$data$payload.forEach(image=>{const isSticker=isV5Sticker(image);if(isSticker){var _currentPayload$stick,_existingLayer$settin,_existingLayer$settin2;const existingLayer=(_currentPayload$stick=currentPayload.stickers)===null||_currentPayload$stick===void 0?void 0:_currentPayload$stick.find(_ref=>{let{uuid}=_ref;return uuid===image.layer.id;});const haveChanges=(existingLayer===null||existingLayer===void 0||(_existingLayer$settin=existingLayer.settings)===null||_existingLayer$settin===void 0?void 0:_existingLayer$settin.sticker)!==image.layer.url||(existingLayer===null||existingLayer===void 0||(_existingLayer$settin2=existingLayer.settings)===null||_existingLayer$settin2===void 0||(_existingLayer$settin2=_existingLayer$settin2.mask)===null||_existingLayer$settin2===void 0?void 0:_existingLayer$settin2.mask)!==image.layer.maskUrl;stickers.push({uuid:image.layer.id,type:'sticker',settings:{...((existingLayer===null||existingLayer===void 0?void 0:existingLayer.settings)||defaultStickerParams),sticker:image.layer.url,mask:{...defaultMask,mask:image.layer.maskUrl}},meta:{...((existingLayer===null||existingLayer===void 0?void 0:existingLayer.meta)||{}),...(haveChanges&&{miniappPackageId:currentPayload.miniapp.packageId})}});}else{var _currentPayload$image,_existingLayer$settin3,_existingLayer$settin4;const existingLayer=(_currentPayload$image=currentPayload.images)===null||_currentPayload$image===void 0?void 0:_currentPayload$image.find(_ref2=>{let{uuid}=_ref2;return uuid===image.layer.id;});const haveChanges=(existingLayer===null||existingLayer===void 0||(_existingLayer$settin3=existingLayer.settings)===null||_existingLayer$settin3===void 0?void 0:_existingLayer$settin3.photo)!==image.layer.url||(existingLayer===null||existingLayer===void 0||(_existingLayer$settin4=existingLayer.settings)===null||_existingLayer$settin4===void 0||(_existingLayer$settin4=_existingLayer$settin4.mask)===null||_existingLayer$settin4===void 0?void 0:_existingLayer$settin4.mask)!==image.layer.maskUrl;images.push({uuid:image.layer.id,type:'photo',settings:{...((existingLayer===null||existingLayer===void 0?void 0:existingLayer.settings)||defaultImageLayerParams),photo:image.layer.url,mask:{...defaultMask,mask:image.layer.maskUrl}},meta:{...((existingLayer===null||existingLayer===void 0?void 0:existingLayer.meta)||{}),...(haveChanges&&{miniappPackageId:currentPayload.miniapp.packageId})}});}});const texts=(_options$data$payload2=options.data.payload.texts)===null||_options$data$payload2===void 0?void 0:_options$data$payload2.map(text=>{var _currentPayload$texts,_exitingLayer$setting,_exitingLayer$setting2;const exitingLayer=(_currentPayload$texts=currentPayload.texts)===null||_currentPayload$texts===void 0?void 0:_currentPayload$texts.find(_ref3=>{let{uuid}=_ref3;return uuid===text.layer.id;});const hasTextLayerChanged=(exitingLayer===null||exitingLayer===void 0||(_exitingLayer$setting=exitingLayer.settings)===null||_exitingLayer$setting===void 0?void 0:_exitingLayer$setting.text)!==text.layer.text||(exitingLayer===null||exitingLayer===void 0||(_exitingLayer$setting2=exitingLayer.settings)===null||_exitingLayer$setting2===void 0?void 0:_exitingLayer$setting2.font)!==text.layer.font;return{uuid:text.layer.id,type:'text',meta:{...((exitingLayer===null||exitingLayer===void 0?void 0:exitingLayer.meta)||{}),...(hasTextLayerChanged&&{miniappPackageId:currentPayload.miniapp.packageId})},settings:{...((exitingLayer===null||exitingLayer===void 0?void 0:exitingLayer.settings)||defaultTextLayerParams),text:text.layer.text,font:text.layer.font}};});(_options$data$payload3=options.data.payload.texts)===null||_options$data$payload3===void 0||_options$data$payload3.forEach(text=>{var _options$data$payload4;const resourceId=text.layer.font||'';const resource=(_options$data$payload4=options.data.payload.resources)===null||_options$data$payload4===void 0?void 0:_options$data$payload4[resourceId];if(resource){resource.type='font';}});(_options$data$payload5=options.data.payload.images)===null||_options$data$payload5===void 0||_options$data$payload5.forEach(image=>{var _options$data$payload6;const resourceId=image.layer.url||'';const resource=(_options$data$payload6=options.data.payload.resources)===null||_options$data$payload6===void 0?void 0:_options$data$payload6[resourceId];if(resource){resource.type='photo';}});Object.values(options.data.payload.resources||{}).forEach(resource=>{resource.type=resource.type||'';});options.data.payload.images=images;options.data.payload.texts=texts;options.data.payload.stickers=stickers;options.data.payload.resources=options.data.payload.resources||{};options.data.payload.selectedLayerIds=options.data.payload.selectedLayerIds||[];options.data.payload.shapes=options.data.payload.shapes||[];options.data.payload.videos=options.data.payload.videos||[];return options;}
const getImageMimeType=(image,options)=>{const resourceId=isStickerLayerData(image)?image.settings.sticker:image.settings.photo;const resources=options.data.payload.resources;if(resources&&resources[resourceId]&&resources[resourceId].location){const location=resources[resourceId].location;const extension=location.split('.').pop();if((extension===null||extension===void 0?void 0:extension.toLocaleLowerCase())==='png'){return 'image/png';}else{return 'image/jpeg';}}
return 'image/jpeg';};function fromReplayV2(options){var _ref,_options$data$payload;const images=(_ref=[...(options.data.payload.images||[]),...(options.data.payload.stickers||[])])===null||_ref===void 0?void 0:_ref.map(image=>{var _image$settings$mask;const result={layer:{id:image.uuid,url:isStickerLayerData(image)?image.settings.sticker:image.settings.photo},mimeType:getImageMimeType(image,options)};if((_image$settings$mask=image.settings.mask)!==null&&_image$settings$mask!==void 0&&_image$settings$mask.mask){result.layer.maskUrl=image.settings.mask.mask;}
return result;});const texts=(_options$data$payload=options.data.payload.texts)===null||_options$data$payload===void 0?void 0:_options$data$payload.map(text=>{return{layer:{text:text.settings.text,font:text.settings.font,id:text.uuid,fontFamily:''},mimeType:'text/plain'};});options.data.payload.images=images;options.data.payload.texts=texts;return options;}
function fileChooserMaxCount(options){if(options.data.action===SendMessages.openFileChooser){options.data.payload.maxCount=options.data.payload.multiSelectEnabled?10:1;}
return options;}
function receiveMessages$2(options){const needToStorePayload=isBootstrapAction(options.data)||isConfirmAction(options.data);if(isBootstrapAction(options.data)){options.data.payload={...options.data.payload,platformVersion:'v6',version:'v6-v5'};}
if(needToStorePayload){window.v6CurrentPayload={...(window.v6CurrentPayload||{}),...JSON.parse(JSON.stringify(options.data.payload))};}
options.data.payload={...(window.v6CurrentPayload||{}),...options.data.payload};return options;}
function runV5ToV6Migrations(options){return migrate(options,{migrateFrom:'v5',migrateTo:'v6'},[fileChooserMaxCount,toReplayV2]);}
function runV6ToV5Migrations(options){return migrate(options,{migrateFrom:'v6',migrateTo:'v5'},[receiveMessages$2,fromReplayV2]);}
function receiveMessages$1(options){const needToStorePayload=isBootstrapAction(options.data)||isConfirmAction(options.data);if(isBootstrapAction(options.data)){options.data.payload={...options.data.payload,platformVersion:'v7',version:'v7-v6'};}
if(needToStorePayload){window.v7CurrentPayload={...(window.v7CurrentPayload||{}),...JSON.parse(JSON.stringify(options.data.payload))};}
options.data.payload={...(window.v7CurrentPayload||{}),...options.data.payload};return options;}
function fromReplayV2Video(options){var _ref;options.data.payload.videos=(_ref=options.data.payload.videos||[])===null||_ref===void 0?void 0:_ref.map(video=>{return{...video,settings:{...video.settings,url:video.settings.video},mimeType:'video/mp4'};});return options;}
const defaultVideoLayerParams={video:'',transform:defaultTransform,blendmode:'normal',visible:true,start_time:0,duration:-1,trim_start:0,trim_end:-1,volume:100};function toReplayV2Video(options){var _options$data$payload;if(!isConfirmAction(options.data))return options;const currentPayload=window.v7CurrentPayload||{};const videos=[];(_options$data$payload=options.data.payload.videos)===null||_options$data$payload===void 0||_options$data$payload.forEach(video=>{var _currentPayload$video,_existingLayer$settin;const existingLayer=(_currentPayload$video=currentPayload.videos)===null||_currentPayload$video===void 0?void 0:_currentPayload$video.find(_ref=>{let{uuid}=_ref;return uuid===video.uuid;});const haveChanges=(existingLayer===null||existingLayer===void 0||(_existingLayer$settin=existingLayer.settings)===null||_existingLayer$settin===void 0?void 0:_existingLayer$settin.video)!==video.settings.url;videos.push({...video,settings:{...((existingLayer===null||existingLayer===void 0?void 0:existingLayer.settings)||defaultVideoLayerParams),video:video.settings.url},meta:{...((existingLayer===null||existingLayer===void 0?void 0:existingLayer.meta)||{}),...(haveChanges&&{miniappPackageId:currentPayload.miniapp.packageId})}});});return{...options,data:{...options.data,payload:{...options.data.payload,videos}}};}
function runV6ToV7Migrations(options){return migrate(options,{migrateFrom:'v6',migrateTo:'v7'},[toReplayV2Video]);}
function runV7ToV6Migrations(options){return migrate(options,{migrateFrom:'v7',migrateTo:'v6'},[receiveMessages$1,fromReplayV2Video]);}
function generateResultImageResponse(options){if(!isGenerateResultImageResponseAction(options.data))return options;return{...options,data:{...options.data,payload:{...options.data.payload,location:options.data.payload.resource.location,type:options.data.payload.resource.type,id:options.data.payload.resource.id,source:'user_generated'}}};}
const sendData=async jsonString=>{if(isWebProtocol())return sendToWeb(jsonString);if(isIOSProtocol())return sendToIos(jsonString);if(isWindowsProtocol())return sendToWindows(jsonString);if(isAndroidProtocol())return sendToAndroid(jsonString);return sendToWeb(jsonString);};function receiveMessages(options){const needToStorePayload=isBootstrapAction(options.data)||isConfirmAction(options.data);if(isBootstrapAction(options.data)){options.data.payload={...options.data.payload,platformVersion:'v8',version:'v8-v7'};}
if(needToStorePayload){window.v8CurrentPayload={...(window.v8CurrentPayload||{}),...JSON.parse(JSON.stringify(options.data.payload))};}
options.data.payload={...(window.v8CurrentPayload||{}),...options.data.payload};if(isResolvableAction(options.data)){sendData(JSON.stringify({action:SendMessages.resolveMessage,resolveId:options.data.resolveId,payload:{}}));}
return options;}
function exportFiles(options){if(!isExportFilesAction(options.data))return options;return{...options,data:{...options.data,payload:{layers:Object.values(options.data.payload.resources||{}).map(resource=>({props:{image:{value:{location:resource.location}}},uuid:resource.id,type:'image',name:'photo',locked:false,mediaType:'photo',renderer:{packageId:'system.image',version:'1.0.0'},meta:{}}))}}};}
var NOTHING=Symbol.for("immer-nothing");var DRAFTABLE=Symbol.for("immer-draftable");var DRAFT_STATE=Symbol.for("immer-state");function die(error){throw new Error("[Immer] minified error nr: ".concat(error,". Full error at: https://bit.ly/3cXEKWf"));}
var getPrototypeOf=Object.getPrototypeOf;function isDraft(value){return!!value&&!!value[DRAFT_STATE];}
function isDraftable(value){var _value$constructor;if(!value)return false;return isPlainObject(value)||Array.isArray(value)||!!value[DRAFTABLE]||!!((_value$constructor=value.constructor)!==null&&_value$constructor!==void 0&&_value$constructor[DRAFTABLE])||isMap(value)||isSet(value);}
var objectCtorString=Object.prototype.constructor.toString();function isPlainObject(value){if(!value||typeof value!=="object")return false;const proto=getPrototypeOf(value);if(proto===null){return true;}
const Ctor=Object.hasOwnProperty.call(proto,"constructor")&&proto.constructor;if(Ctor===Object)return true;return typeof Ctor=="function"&&Function.toString.call(Ctor)===objectCtorString;}
function each(obj,iter){if(getArchtype(obj)===0){Object.entries(obj).forEach(_ref8=>{let[key,value]=_ref8;iter(key,value,obj);});}else{obj.forEach((entry,index)=>iter(index,entry,obj));}}
function getArchtype(thing){const state=thing[DRAFT_STATE];return state?state.type_:Array.isArray(thing)?1:isMap(thing)?2:isSet(thing)?3:0;}
function has(thing,prop){return getArchtype(thing)===2?thing.has(prop):Object.prototype.hasOwnProperty.call(thing,prop);}
function set(thing,propOrOldValue,value){const t=getArchtype(thing);if(t===2)thing.set(propOrOldValue,value);else if(t===3){thing.add(value);}else thing[propOrOldValue]=value;}
function is(x,y){if(x===y){return x!==0||1/x===1/y;}else{return x!==x&&y!==y;}}
function isMap(target){return target instanceof Map;}
function isSet(target){return target instanceof Set;}
function latest(state){return state.copy_||state.base_;}
function shallowCopy(base,strict){if(isMap(base)){return new Map(base);}
if(isSet(base)){return new Set(base);}
if(Array.isArray(base))return Array.prototype.slice.call(base);if(!strict&&isPlainObject(base)){if(!getPrototypeOf(base)){const obj=Object.create(null);return Object.assign(obj,base);}
return{...base};}
const descriptors=Object.getOwnPropertyDescriptors(base);delete descriptors[DRAFT_STATE];let keys=Reflect.ownKeys(descriptors);for(let i=0;i<keys.length;i++){const key=keys[i];const desc=descriptors[key];if(desc.writable===false){desc.writable=true;desc.configurable=true;}
if(desc.get||desc.set)descriptors[key]={configurable:true,writable:true,enumerable:desc.enumerable,value:base[key]};}
return Object.create(getPrototypeOf(base),descriptors);}
function freeze(obj){let deep=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(isFrozen(obj)||isDraft(obj)||!isDraftable(obj))return obj;if(getArchtype(obj)>1){obj.set=obj.add=obj.clear=obj.delete=dontMutateFrozenCollections;}
Object.freeze(obj);if(deep)each(obj,(_key,value)=>freeze(value,true));return obj;}
function dontMutateFrozenCollections(){die(2);}
function isFrozen(obj){return Object.isFrozen(obj);}
var plugins={};function getPlugin(pluginKey){const plugin=plugins[pluginKey];if(!plugin){die(0);}
return plugin;}
var currentScope;function getCurrentScope(){return currentScope;}
function createScope(parent_,immer_){return{drafts_:[],parent_,immer_,canAutoFreeze_:true,unfinalizedDrafts_:0};}
function usePatchesInScope(scope,patchListener){if(patchListener){getPlugin("Patches");scope.patches_=[];scope.inversePatches_=[];scope.patchListener_=patchListener;}}
function revokeScope(scope){leaveScope(scope);scope.drafts_.forEach(revokeDraft);scope.drafts_=null;}
function leaveScope(scope){if(scope===currentScope){currentScope=scope.parent_;}}
function enterScope(immer2){return currentScope=createScope(currentScope,immer2);}
function revokeDraft(draft){const state=draft[DRAFT_STATE];if(state.type_===0||state.type_===1)state.revoke_();else state.revoked_=true;}
function processResult(result,scope){scope.unfinalizedDrafts_=scope.drafts_.length;const baseDraft=scope.drafts_[0];const isReplaced=result!==void 0&&result!==baseDraft;if(isReplaced){if(baseDraft[DRAFT_STATE].modified_){revokeScope(scope);die(4);}
if(isDraftable(result)){result=finalize(scope,result);if(!scope.parent_)maybeFreeze(scope,result);}
if(scope.patches_){getPlugin("Patches").generateReplacementPatches_(baseDraft[DRAFT_STATE].base_,result,scope.patches_,scope.inversePatches_);}}else{result=finalize(scope,baseDraft,[]);}
revokeScope(scope);if(scope.patches_){scope.patchListener_(scope.patches_,scope.inversePatches_);}
return result!==NOTHING?result:void 0;}
function finalize(rootScope,value,path){if(isFrozen(value))return value;const state=value[DRAFT_STATE];if(!state){each(value,(key,childValue)=>finalizeProperty(rootScope,state,value,key,childValue,path));return value;}
if(state.scope_!==rootScope)return value;if(!state.modified_){maybeFreeze(rootScope,state.base_,true);return state.base_;}
if(!state.finalized_){state.finalized_=true;state.scope_.unfinalizedDrafts_--;const result=state.copy_;let resultEach=result;let isSet2=false;if(state.type_===3){resultEach=new Set(result);result.clear();isSet2=true;}
each(resultEach,(key,childValue)=>finalizeProperty(rootScope,state,result,key,childValue,path,isSet2));maybeFreeze(rootScope,result,false);if(path&&rootScope.patches_){getPlugin("Patches").generatePatches_(state,path,rootScope.patches_,rootScope.inversePatches_);}}
return state.copy_;}
function finalizeProperty(rootScope,parentState,targetObject,prop,childValue,rootPath,targetIsSet){if(isDraft(childValue)){const path=rootPath&&parentState&&parentState.type_!==3&&!has(parentState.assigned_,prop)?rootPath.concat(prop):void 0;const res=finalize(rootScope,childValue,path);set(targetObject,prop,res);if(isDraft(res)){rootScope.canAutoFreeze_=false;}else return;}else if(targetIsSet){targetObject.add(childValue);}
if(isDraftable(childValue)&&!isFrozen(childValue)){if(!rootScope.immer_.autoFreeze_&&rootScope.unfinalizedDrafts_<1){return;}
finalize(rootScope,childValue);if(!parentState||!parentState.scope_.parent_)maybeFreeze(rootScope,childValue);}}
function maybeFreeze(scope,value){let deep=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;if(!scope.parent_&&scope.immer_.autoFreeze_&&scope.canAutoFreeze_){freeze(value,deep);}}
function createProxyProxy(base,parent){const isArray=Array.isArray(base);const state={type_:isArray?1:0,scope_:parent?parent.scope_:getCurrentScope(),modified_:false,finalized_:false,assigned_:{},parent_:parent,base_:base,draft_:null,copy_:null,revoke_:null,isManual_:false};let target=state;let traps=objectTraps;if(isArray){target=[state];traps=arrayTraps;}
const{revoke,proxy}=Proxy.revocable(target,traps);state.draft_=proxy;state.revoke_=revoke;return proxy;}
var objectTraps={get(state,prop){if(prop===DRAFT_STATE)return state;const source=latest(state);if(!has(source,prop)){return readPropFromProto(state,source,prop);}
const value=source[prop];if(state.finalized_||!isDraftable(value)){return value;}
if(value===peek(state.base_,prop)){prepareCopy(state);return state.copy_[prop]=createProxy(value,state);}
return value;},has(state,prop){return prop in latest(state);},ownKeys(state){return Reflect.ownKeys(latest(state));},set(state,prop,value){const desc=getDescriptorFromProto(latest(state),prop);if(desc!==null&&desc!==void 0&&desc.set){desc.set.call(state.draft_,value);return true;}
if(!state.modified_){const current2=peek(latest(state),prop);const currentState=current2===null||current2===void 0?void 0:current2[DRAFT_STATE];if(currentState&&currentState.base_===value){state.copy_[prop]=value;state.assigned_[prop]=false;return true;}
if(is(value,current2)&&(value!==void 0||has(state.base_,prop)))return true;prepareCopy(state);markChanged(state);}
if(state.copy_[prop]===value&&(value!==void 0||prop in state.copy_)||Number.isNaN(value)&&Number.isNaN(state.copy_[prop]))return true;state.copy_[prop]=value;state.assigned_[prop]=true;return true;},deleteProperty(state,prop){if(peek(state.base_,prop)!==void 0||prop in state.base_){state.assigned_[prop]=false;prepareCopy(state);markChanged(state);}else{delete state.assigned_[prop];}
if(state.copy_){delete state.copy_[prop];}
return true;},getOwnPropertyDescriptor(state,prop){const owner=latest(state);const desc=Reflect.getOwnPropertyDescriptor(owner,prop);if(!desc)return desc;return{writable:true,configurable:state.type_!==1||prop!=="length",enumerable:desc.enumerable,value:owner[prop]};},defineProperty(){die(11);},getPrototypeOf(state){return getPrototypeOf(state.base_);},setPrototypeOf(){die(12);}};var arrayTraps={};each(objectTraps,(key,fn)=>{arrayTraps[key]=function(){arguments[0]=arguments[0][0];return fn.apply(this,arguments);};});arrayTraps.deleteProperty=function(state,prop){return arrayTraps.set.call(this,state,prop,void 0);};arrayTraps.set=function(state,prop,value){return objectTraps.set.call(this,state[0],prop,value,state[0]);};function peek(draft,prop){const state=draft[DRAFT_STATE];const source=state?latest(state):draft;return source[prop];}
function readPropFromProto(state,source,prop){var _desc$get;const desc=getDescriptorFromProto(source,prop);return desc?"value"in desc?desc.value:(_desc$get=desc.get)===null||_desc$get===void 0?void 0:_desc$get.call(state.draft_):void 0;}
function getDescriptorFromProto(source,prop){if(!(prop in source))return void 0;let proto=getPrototypeOf(source);while(proto){const desc=Object.getOwnPropertyDescriptor(proto,prop);if(desc)return desc;proto=getPrototypeOf(proto);}
return void 0;}
function markChanged(state){if(!state.modified_){state.modified_=true;if(state.parent_){markChanged(state.parent_);}}}
function prepareCopy(state){if(!state.copy_){state.copy_=shallowCopy(state.base_,state.scope_.immer_.useStrictShallowCopy_);}}
var Immer2=class{constructor(config){var _this=this;this.autoFreeze_=true;this.useStrictShallowCopy_=false;this.produce=(base,recipe,patchListener)=>{if(typeof base==="function"&&typeof recipe!=="function"){const defaultBase=recipe;recipe=base;const self=this;return function curriedProduce(){let base2=arguments.length>0&&arguments[0]!==undefined?arguments[0]:defaultBase;for(var _len2=arguments.length,args=new Array(_len2>1?_len2-1:0),_key3=1;_key3<_len2;_key3++){args[_key3-1]=arguments[_key3];}
return self.produce(base2,draft=>recipe.call(this,draft,...args));};}
if(typeof recipe!=="function")die(6);if(patchListener!==void 0&&typeof patchListener!=="function")die(7);let result;if(isDraftable(base)){const scope=enterScope(this);const proxy=createProxy(base,void 0);let hasError=true;try{result=recipe(proxy);hasError=false;}finally{if(hasError)revokeScope(scope);else leaveScope(scope);}
usePatchesInScope(scope,patchListener);return processResult(result,scope);}else if(!base||typeof base!=="object"){result=recipe(base);if(result===void 0)result=base;if(result===NOTHING)result=void 0;if(this.autoFreeze_)freeze(result,true);if(patchListener){const p=[];const ip=[];getPlugin("Patches").generateReplacementPatches_(base,result,p,ip);patchListener(p,ip);}
return result;}else die(1);};this.produceWithPatches=(base,recipe)=>{if(typeof base==="function"){return function(state){for(var _len3=arguments.length,args=new Array(_len3>1?_len3-1:0),_key4=1;_key4<_len3;_key4++){args[_key4-1]=arguments[_key4];}
return _this.produceWithPatches(state,draft=>base(draft,...args));};}
let patches,inversePatches;const result=this.produce(base,recipe,(p,ip)=>{patches=p;inversePatches=ip;});return[result,patches,inversePatches];};if(typeof(config===null||config===void 0?void 0:config.autoFreeze)==="boolean")this.setAutoFreeze(config.autoFreeze);if(typeof(config===null||config===void 0?void 0:config.useStrictShallowCopy)==="boolean")this.setUseStrictShallowCopy(config.useStrictShallowCopy);}
createDraft(base){if(!isDraftable(base))die(8);if(isDraft(base))base=current(base);const scope=enterScope(this);const proxy=createProxy(base,void 0);proxy[DRAFT_STATE].isManual_=true;leaveScope(scope);return proxy;}
finishDraft(draft,patchListener){const state=draft&&draft[DRAFT_STATE];if(!state||!state.isManual_)die(9);const{scope_:scope}=state;usePatchesInScope(scope,patchListener);return processResult(void 0,scope);}
setAutoFreeze(value){this.autoFreeze_=value;}
setUseStrictShallowCopy(value){this.useStrictShallowCopy_=value;}
applyPatches(base,patches){let i;for(i=patches.length-1;i>=0;i--){const patch=patches[i];if(patch.path.length===0&&patch.op==="replace"){base=patch.value;break;}}
if(i>-1){patches=patches.slice(i+1);}
const applyPatchesImpl=getPlugin("Patches").applyPatches_;if(isDraft(base)){return applyPatchesImpl(base,patches);}
return this.produce(base,draft=>applyPatchesImpl(draft,patches));}};function createProxy(value,parent){const draft=isMap(value)?getPlugin("MapSet").proxyMap_(value,parent):isSet(value)?getPlugin("MapSet").proxySet_(value,parent):createProxyProxy(value,parent);const scope=parent?parent.scope_:getCurrentScope();scope.drafts_.push(draft);return draft;}
function current(value){if(!isDraft(value))die(10);return currentImpl(value);}
function currentImpl(value){if(!isDraftable(value)||isFrozen(value))return value;const state=value[DRAFT_STATE];let copy;if(state){if(!state.modified_)return state.base_;state.finalized_=true;copy=shallowCopy(value,state.scope_.immer_.useStrictShallowCopy_);}else{copy=shallowCopy(value,true);}
each(copy,(key,childValue)=>{set(copy,key,currentImpl(childValue));});if(state){state.finalized_=false;}
return copy;}
var immer=new Immer2();var produce=immer.produce;immer.produceWithPatches.bind(immer);var setAutoFreeze=immer.setAutoFreeze.bind(immer);immer.setUseStrictShallowCopy.bind(immer);immer.applyPatches.bind(immer);immer.createDraft.bind(immer);immer.finishDraft.bind(immer);let getRandomValues;const rnds8=new Uint8Array(16);function rng(){if(!getRandomValues){getRandomValues=typeof crypto!=='undefined'&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto);if(!getRandomValues){throw new Error('crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported');}}
return getRandomValues(rnds8);}
const byteToHex=[];for(let i=0;i<256;++i){byteToHex.push((i+0x100).toString(16).slice(1));}
function unsafeStringify(arr){let offset=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;return byteToHex[arr[offset+0]]+byteToHex[arr[offset+1]]+byteToHex[arr[offset+2]]+byteToHex[arr[offset+3]]+'-'+byteToHex[arr[offset+4]]+byteToHex[arr[offset+5]]+'-'+byteToHex[arr[offset+6]]+byteToHex[arr[offset+7]]+'-'+byteToHex[arr[offset+8]]+byteToHex[arr[offset+9]]+'-'+byteToHex[arr[offset+10]]+byteToHex[arr[offset+11]]+byteToHex[arr[offset+12]]+byteToHex[arr[offset+13]]+byteToHex[arr[offset+14]]+byteToHex[arr[offset+15]];}
const randomUUID=typeof crypto!=='undefined'&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);var native={randomUUID};function v4(options,buf,offset){if(native.randomUUID&&!buf&&!options){return native.randomUUID();}
options=options||{};const rnds=options.random||(options.rng||rng)();rnds[6]=rnds[6]&0x0f|0x40;rnds[8]=rnds[8]&0x3f|0x80;return unsafeStringify(rnds);}
const DEFAULT_X=0;const DEFAULT_Y=0;const DEFAULT_BEND=0;const DEFAULT_PATH='';const CRATE_DEFAULT_META=()=>({});const DEFAULT_OPACITY=1;const DEFAULT_SCALE_X=1;const DEFAULT_SCALE_Y=1;const CREATE_DEFAULT_PATHS=()=>[];const DEFAULT_ROTATION=0;const DEFAULT_STROKE=null;const DEFAULT_LOCKED=false;const CREATE_DEFAULT_CHILDREN=()=>[];const DEFAULT_HIDDEN=false;const DEFAULT_SHADOW=null;const DEFAULT_DURATION=-1;const DEFAULT_START_TIME=0;const DEFAULT_LINE_HEIGHT=100;const CREATE_DEFAULT_ANIMATIONS=()=>[];const DEFAULT_LETTER_SPACING=0;const DEFAULT_ALIGNMENT='center';const DEFAULT_PERSPECTIVE_POINTS=null;const DEFAULT_BLEND_MODE='source-over';const SYSTEM_TEXT='system.text';const SYSTEM_IMAGE='system.image';const SYSTEM_SHAPE='system.shape';const SYSTEM_GROUP='system.group';const SYSTEM_VIDEO='system.video';const SYSTEM_RENDERER_VERSION='1.0.0';const CREATE_SYSTEM_RENDERER=packageId=>({packageId,version:SYSTEM_RENDERER_VERSION});const COEFFICIENT=1000000;const createReplayLayerProperty=function(value){let locked=arguments.length>1&&arguments[1]!==undefined?arguments[1]:DEFAULT_LOCKED;let meta=arguments.length>2&&arguments[2]!==undefined?arguments[2]:CRATE_DEFAULT_META();return{value:typeof value==='number'?Math.floor(value*COEFFICIENT)/COEFFICIENT:value,locked,meta};};const createReplayGroupLayer=_ref=>{let{name,meta=CRATE_DEFAULT_META(),uuid=v4(),locked=DEFAULT_LOCKED,renderer=CREATE_SYSTEM_RENDERER(SYSTEM_GROUP),fallbackLayer,mediaType,props:{width,height,x=DEFAULT_X,y=DEFAULT_Y,scaleY=DEFAULT_SCALE_Y,hidden=DEFAULT_HIDDEN,scaleX=DEFAULT_SCALE_X,opacity=DEFAULT_OPACITY,rotation=DEFAULT_ROTATION,children=CREATE_DEFAULT_CHILDREN(),duration=DEFAULT_DURATION,startTime=DEFAULT_START_TIME,animations=CREATE_DEFAULT_ANIMATIONS(),blendMode=DEFAULT_BLEND_MODE}}=_ref;const groupLayer={uuid,name,meta,locked,type:'group',renderer,fallbackLayer,mediaType,props:{x:createReplayLayerProperty(x),y:createReplayLayerProperty(y),width:createReplayLayerProperty(width),height:createReplayLayerProperty(height),scaleY:createReplayLayerProperty(scaleY),scaleX:createReplayLayerProperty(scaleX),hidden:createReplayLayerProperty(hidden),opacity:createReplayLayerProperty(opacity),rotation:createReplayLayerProperty(rotation),children:createReplayLayerProperty(children),duration:createReplayLayerProperty(duration),startTime:createReplayLayerProperty(startTime),blendMode:createReplayLayerProperty(blendMode),animations:createReplayLayerProperty(animations)}};return groupLayer;};const createReplayShapeLayer=_ref2=>{let{name,meta=CRATE_DEFAULT_META(),uuid=v4(),locked=DEFAULT_LOCKED,renderer=CREATE_SYSTEM_RENDERER(SYSTEM_SHAPE),fallbackLayer,mediaType,props:{shape,width,height,x=DEFAULT_X,y=DEFAULT_Y,paths=CREATE_DEFAULT_PATHS(),scaleY=DEFAULT_SCALE_Y,stroke=DEFAULT_STROKE,scaleX=DEFAULT_SCALE_X,hidden=DEFAULT_HIDDEN,opacity=DEFAULT_OPACITY,shadow=DEFAULT_SHADOW,rotation=DEFAULT_ROTATION,duration=DEFAULT_DURATION,startTime=DEFAULT_START_TIME,blendMode=DEFAULT_BLEND_MODE,animations=CREATE_DEFAULT_ANIMATIONS()}}=_ref2;const shapeLayer={uuid,name,meta,locked,type:'shape',renderer,fallbackLayer,mediaType,props:{x:createReplayLayerProperty(x),y:createReplayLayerProperty(y),width:createReplayLayerProperty(width),shape:createReplayLayerProperty(shape),paths:createReplayLayerProperty(paths),stroke:createReplayLayerProperty(stroke),scaleY:createReplayLayerProperty(scaleY),height:createReplayLayerProperty(height),scaleX:createReplayLayerProperty(scaleX),hidden:createReplayLayerProperty(hidden),shadow:createReplayLayerProperty(shadow),opacity:createReplayLayerProperty(opacity),rotation:createReplayLayerProperty(rotation),duration:createReplayLayerProperty(duration),startTime:createReplayLayerProperty(startTime),blendMode:createReplayLayerProperty(blendMode),animations:createReplayLayerProperty(animations)}};return shapeLayer;};const createReplayTextLayer=_ref3=>{let{name,meta=CRATE_DEFAULT_META(),uuid=v4(),locked=DEFAULT_LOCKED,renderer=CREATE_SYSTEM_RENDERER(SYSTEM_TEXT),fallbackLayer,mediaType,props:{font,width,ranges,y=DEFAULT_Y,x=DEFAULT_X,bend=DEFAULT_BEND,path=DEFAULT_PATH,stroke=DEFAULT_STROKE,scaleY=DEFAULT_SCALE_Y,scaleX=DEFAULT_SCALE_X,hidden=DEFAULT_HIDDEN,opacity=DEFAULT_OPACITY,shadow=DEFAULT_SHADOW,rotation=DEFAULT_ROTATION,duration=DEFAULT_DURATION,startTime=DEFAULT_START_TIME,alignment=DEFAULT_ALIGNMENT,blendMode=DEFAULT_BLEND_MODE,lineHeight=DEFAULT_LINE_HEIGHT,letterSpacing=DEFAULT_LETTER_SPACING,animations=CREATE_DEFAULT_ANIMATIONS(),perspectivePoints=DEFAULT_PERSPECTIVE_POINTS}}=_ref3;const textLayer={uuid,name,meta,locked,type:'text',renderer,fallbackLayer,mediaType,props:{x:createReplayLayerProperty(x),y:createReplayLayerProperty(y),font:createReplayLayerProperty(font),bend:createReplayLayerProperty(bend),path:createReplayLayerProperty(path),width:createReplayLayerProperty(width),stroke:createReplayLayerProperty(stroke),scaleY:createReplayLayerProperty(scaleY),ranges:createReplayLayerProperty(ranges),scaleX:createReplayLayerProperty(scaleX),hidden:createReplayLayerProperty(hidden),shadow:createReplayLayerProperty(shadow),opacity:createReplayLayerProperty(opacity),rotation:createReplayLayerProperty(rotation),duration:createReplayLayerProperty(duration),startTime:createReplayLayerProperty(startTime),alignment:createReplayLayerProperty(alignment),blendMode:createReplayLayerProperty(blendMode),lineHeight:createReplayLayerProperty(lineHeight),letterSpacing:createReplayLayerProperty(letterSpacing),perspectivePoints:createReplayLayerProperty(perspectivePoints),animations:createReplayLayerProperty(animations)}};return textLayer;};const createReplayImageLayer=_ref4=>{let{name,meta=CRATE_DEFAULT_META(),uuid=v4(),locked=DEFAULT_LOCKED,renderer=CREATE_SYSTEM_RENDERER(SYSTEM_IMAGE),fallbackLayer,mediaType,props:{image,y=DEFAULT_Y,x=DEFAULT_X,stroke=DEFAULT_STROKE,scaleY=DEFAULT_SCALE_Y,hidden=DEFAULT_HIDDEN,scaleX=DEFAULT_SCALE_X,opacity=DEFAULT_OPACITY,shadow=DEFAULT_SHADOW,rotation=DEFAULT_ROTATION,duration=DEFAULT_DURATION,startTime=DEFAULT_START_TIME,blendMode=DEFAULT_BLEND_MODE,animations=CREATE_DEFAULT_ANIMATIONS()}}=_ref4;const imageLayer={uuid,name,meta,locked,type:'image',renderer,fallbackLayer,mediaType,props:{x:createReplayLayerProperty(x),y:createReplayLayerProperty(y),stroke:createReplayLayerProperty(stroke),image:createReplayLayerProperty(image),scaleY:createReplayLayerProperty(scaleY),scaleX:createReplayLayerProperty(scaleX),hidden:createReplayLayerProperty(hidden),shadow:createReplayLayerProperty(shadow),opacity:createReplayLayerProperty(opacity),rotation:createReplayLayerProperty(rotation),duration:createReplayLayerProperty(duration),startTime:createReplayLayerProperty(startTime),blendMode:createReplayLayerProperty(blendMode),animations:createReplayLayerProperty(animations)}};return imageLayer;};const createReplayVideoLayer=_ref5=>{let{name,uuid=v4(),meta=CRATE_DEFAULT_META(),locked=DEFAULT_LOCKED,renderer=CREATE_SYSTEM_RENDERER(SYSTEM_VIDEO),fallbackLayer,mediaType,props:{video,volume,trimEnd,trimStart,y=DEFAULT_Y,x=DEFAULT_X,hidden=DEFAULT_HIDDEN,scaleY=DEFAULT_SCALE_Y,scaleX=DEFAULT_SCALE_X,opacity=DEFAULT_OPACITY,rotation=DEFAULT_ROTATION,duration=DEFAULT_DURATION,startTime=DEFAULT_START_TIME,animations=CREATE_DEFAULT_ANIMATIONS(),blendMode=DEFAULT_BLEND_MODE}}=_ref5;const videoLayer={uuid,name,meta,locked,type:'video',renderer,fallbackLayer,mediaType,props:{x:createReplayLayerProperty(x),y:createReplayLayerProperty(y),video:createReplayLayerProperty(video),scaleY:createReplayLayerProperty(scaleY),scaleX:createReplayLayerProperty(scaleX),hidden:createReplayLayerProperty(hidden),opacity:createReplayLayerProperty(opacity),volume:createReplayLayerProperty(volume),trimEnd:createReplayLayerProperty(trimEnd),rotation:createReplayLayerProperty(rotation),duration:createReplayLayerProperty(duration),trimStart:createReplayLayerProperty(trimStart),startTime:createReplayLayerProperty(startTime),blendMode:createReplayLayerProperty(blendMode),animations:createReplayLayerProperty(animations)}};return videoLayer;};const isReplayTextLayer=layer=>layer.type==='text';const isReplayVideoLayer=layer=>layer.type==='video';const isReplayAudioLayer=layer=>layer.type==='audio';const isReplayShapeLayer=layer=>layer.type==='shape';const isReplayGroupLayer=layer=>layer.type==='group';const isReplayImageLayer=layer=>layer.type==='image';const isReplayProjectLayer=layer=>layer.mediaType==='PROJECT_ROOT';const findReplayLayerParent=(replay,layerId)=>Object.values(replay.context.layers).find(layer=>isReplayGroupLayer(layer)&&layer.props.children.value.includes(layerId));const findReplayLayerChildren=(replay,layerId)=>{const groupLayer=replay.context.layers[layerId];if(!isReplayGroupLayer(groupLayer)){throw new Error('Layer is not a group');}
return groupLayer.props.children.value.map(childLayerId=>replay.context.layers[childLayerId]);};const unGroupReplayLayers=(replay,parentLayerId)=>{return produce(replay,draft=>{const parentLayer=draft.context.layers[parentLayerId];if(!isReplayGroupLayer(parentLayer))return;const childLayers=parentLayer.props.children.value.map(childId=>draft.context.layers[childId]);childLayers.forEach(childLayer=>{if(isReplayAudioLayer(childLayer))return;childLayer.props.scaleX.value*=parentLayer.props.scaleX.value;childLayer.props.scaleY.value*=parentLayer.props.scaleY.value;childLayer.props.rotation.value+=parentLayer.props.rotation.value;childLayer.props.x.value+=parentLayer.props.x.value+parentLayer.props.width.value*childLayer.props.x.value;childLayer.props.y.value+=parentLayer.props.y.value+parentLayer.props.height.value*childLayer.props.y.value;});const destinationParentLayer=findReplayLayerParent(draft,parentLayerId);if(!destinationParentLayer)return;const parentIndex=destinationParentLayer.props.children.value.indexOf(parentLayerId);destinationParentLayer.props.children.value.splice(parentIndex,1,...parentLayer.props.children.value);});};const removeReplayLayer=function(replay,layerId){let{removeEmptyParent=true}=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};return produce(replay,draft=>{delete draft.context.layers[layerId];const parentLayer=findReplayLayerParent(draft,layerId);if(!parentLayer)return;parentLayer.props.children.value.splice(parentLayer.props.children.value.findIndex(child=>child===layerId),1);if(removeEmptyParent&&parentLayer.props.children.value.length===0&&!isReplayProjectLayer(parentLayer)){unGroupReplayLayers(draft,parentLayer.uuid);removeReplayLayer(draft,parentLayer.uuid);}});};setAutoFreeze(false);const parseBlendMode$1=blendMode=>{return blendMode==='normal'?'source-over':blendMode.replaceAll('_','-');};const parsePattern$1=pattern=>{const{texture,gradient,solid}=pattern;const v3Texture=texture?{location:texture,type:'photo',id:generateId()}:undefined;const v3Gradient=gradient&&{type:'linear',colors:gradient.colors.map(color=>({value:color,percentage:100})),angle:gradient.angle};const type=gradient?'gradient':solid?'color':'image';return{type,color:solid,gradient:v3Gradient,texture:v3Texture};};const parseStroke$1=stroke=>{return{...stroke,pattern:parsePattern$1(stroke.pattern)};};const parseShadow$1=shadow=>{const{offset_y,offset_x}=shadow;return{...shadow,offset:{x:offset_x,y:offset_y}};};var LayerMediaType=function(LayerMediaType){LayerMediaType["photo"]="PHOTO";LayerMediaType["video"]="VIDEO";LayerMediaType["text"]="TEXT";LayerMediaType["sticker"]="STICKER";LayerMediaType["shape"]="SHAPE";LayerMediaType["backgroundImage"]="BACKGROUND_IMAGE";LayerMediaType["backgroundColor"]="BACKGROUND_COLOR";LayerMediaType["svgSticker"]="SVG_STICKER";LayerMediaType["crop"]="CROP";LayerMediaType["overlay"]="OVERLAY";LayerMediaType["highlight"]="HIGHLIGHT";LayerMediaType["mask"]="MASK";LayerMediaType["collageCellImage"]="COLLAGE_CELL_IMAGE";LayerMediaType["collageCellVideo"]="COLLAGE_CELL_VIDEO";LayerMediaType["collageCell"]="COLLAGE_CELL";LayerMediaType["aoEffect"]="AO_EFFECT";LayerMediaType["isiTextBackground"]="ISI_TEXT_BACKGROUND";LayerMediaType["isiTextCell"]="ISI_TEXT_CELL";LayerMediaType["isiTextPaddingTop"]="ISI_TEXT_PADDING_TOP";LayerMediaType["isiTextPaddingBottom"]="ISI_TEXT_PADDING_BOTTOM";LayerMediaType["projectRoot"]="PROJECT_ROOT";LayerMediaType["canvasGroup"]="CANVAS_GROUP";LayerMediaType["group"]="GROUP";LayerMediaType["textHighlightGroup"]="TEXT_HIGHLIGHT_GROUP";LayerMediaType["overlayGroup"]="OVERLAY_GROUP";LayerMediaType["maskGroup"]="MASK_GROUP";LayerMediaType["cropGroup"]="CROP_GROUP";LayerMediaType["collageGroup"]="COLLAGE_GROUP";LayerMediaType["collageCellGroup"]="COLLAGE_CELL_GROUP";return LayerMediaType;}(LayerMediaType||{});function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj;}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;},_typeof(obj);}
var trimLeft=/^\s+/;var trimRight=/\s+$/;function tinycolor(color,opts){color=color?color:"";opts=opts||{};if(color instanceof tinycolor){return color;}
if(!(this instanceof tinycolor)){return new tinycolor(color,opts);}
var rgb=inputToRGB(color);this._originalInput=color,this._r=rgb.r,this._g=rgb.g,this._b=rgb.b,this._a=rgb.a,this._roundA=Math.round(100*this._a)/100,this._format=opts.format||rgb.format;this._gradientType=opts.gradientType;if(this._r<1)this._r=Math.round(this._r);if(this._g<1)this._g=Math.round(this._g);if(this._b<1)this._b=Math.round(this._b);this._ok=rgb.ok;}
tinycolor.prototype={isDark:function isDark(){return this.getBrightness()<128;},isLight:function isLight(){return!this.isDark();},isValid:function isValid(){return this._ok;},getOriginalInput:function getOriginalInput(){return this._originalInput;},getFormat:function getFormat(){return this._format;},getAlpha:function getAlpha(){return this._a;},getBrightness:function getBrightness(){var rgb=this.toRgb();return(rgb.r*299+rgb.g*587+rgb.b*114)/1000;},getLuminance:function getLuminance(){var rgb=this.toRgb();var RsRGB,GsRGB,BsRGB,R,G,B;RsRGB=rgb.r/255;GsRGB=rgb.g/255;BsRGB=rgb.b/255;if(RsRGB<=0.03928)R=RsRGB/12.92;else R=Math.pow((RsRGB+0.055)/1.055,2.4);if(GsRGB<=0.03928)G=GsRGB/12.92;else G=Math.pow((GsRGB+0.055)/1.055,2.4);if(BsRGB<=0.03928)B=BsRGB/12.92;else B=Math.pow((BsRGB+0.055)/1.055,2.4);return 0.2126*R+0.7152*G+0.0722*B;},setAlpha:function setAlpha(value){this._a=boundAlpha(value);this._roundA=Math.round(100*this._a)/100;return this;},toHsv:function toHsv(){var hsv=rgbToHsv(this._r,this._g,this._b);return{h:hsv.h*360,s:hsv.s,v:hsv.v,a:this._a};},toHsvString:function toHsvString(){var hsv=rgbToHsv(this._r,this._g,this._b);var h=Math.round(hsv.h*360),s=Math.round(hsv.s*100),v=Math.round(hsv.v*100);return this._a==1?"hsv("+h+", "+s+"%, "+v+"%)":"hsva("+h+", "+s+"%, "+v+"%, "+this._roundA+")";},toHsl:function toHsl(){var hsl=rgbToHsl(this._r,this._g,this._b);return{h:hsl.h*360,s:hsl.s,l:hsl.l,a:this._a};},toHslString:function toHslString(){var hsl=rgbToHsl(this._r,this._g,this._b);var h=Math.round(hsl.h*360),s=Math.round(hsl.s*100),l=Math.round(hsl.l*100);return this._a==1?"hsl("+h+", "+s+"%, "+l+"%)":"hsla("+h+", "+s+"%, "+l+"%, "+this._roundA+")";},toHex:function toHex(allow3Char){return rgbToHex(this._r,this._g,this._b,allow3Char);},toHexString:function toHexString(allow3Char){return "#"+this.toHex(allow3Char);},toHex8:function toHex8(allow4Char){return rgbaToHex(this._r,this._g,this._b,this._a,allow4Char);},toHex8String:function toHex8String(allow4Char){return "#"+this.toHex8(allow4Char);},toRgb:function toRgb(){return{r:Math.round(this._r),g:Math.round(this._g),b:Math.round(this._b),a:this._a};},toRgbString:function toRgbString(){return this._a==1?"rgb("+Math.round(this._r)+", "+Math.round(this._g)+", "+Math.round(this._b)+")":"rgba("+Math.round(this._r)+", "+Math.round(this._g)+", "+Math.round(this._b)+", "+this._roundA+")";},toPercentageRgb:function toPercentageRgb(){return{r:Math.round(bound01(this._r,255)*100)+"%",g:Math.round(bound01(this._g,255)*100)+"%",b:Math.round(bound01(this._b,255)*100)+"%",a:this._a};},toPercentageRgbString:function toPercentageRgbString(){return this._a==1?"rgb("+Math.round(bound01(this._r,255)*100)+"%, "+Math.round(bound01(this._g,255)*100)+"%, "+Math.round(bound01(this._b,255)*100)+"%)":"rgba("+Math.round(bound01(this._r,255)*100)+"%, "+Math.round(bound01(this._g,255)*100)+"%, "+Math.round(bound01(this._b,255)*100)+"%, "+this._roundA+")";},toName:function toName(){if(this._a===0){return "transparent";}
if(this._a<1){return false;}
return hexNames[rgbToHex(this._r,this._g,this._b,true)]||false;},toFilter:function toFilter(secondColor){var hex8String="#"+rgbaToArgbHex(this._r,this._g,this._b,this._a);var secondHex8String=hex8String;var gradientType=this._gradientType?"GradientType = 1, ":"";if(secondColor){var s=tinycolor(secondColor);secondHex8String="#"+rgbaToArgbHex(s._r,s._g,s._b,s._a);}
return "progid:DXImageTransform.Microsoft.gradient("+gradientType+"startColorstr="+hex8String+",endColorstr="+secondHex8String+")";},toString:function toString(format){var formatSet=!!format;format=format||this._format;var formattedString=false;var hasAlpha=this._a<1&&this._a>=0;var needsAlphaFormat=!formatSet&&hasAlpha&&(format==="hex"||format==="hex6"||format==="hex3"||format==="hex4"||format==="hex8"||format==="name");if(needsAlphaFormat){if(format==="name"&&this._a===0){return this.toName();}
return this.toRgbString();}
if(format==="rgb"){formattedString=this.toRgbString();}
if(format==="prgb"){formattedString=this.toPercentageRgbString();}
if(format==="hex"||format==="hex6"){formattedString=this.toHexString();}
if(format==="hex3"){formattedString=this.toHexString(true);}
if(format==="hex4"){formattedString=this.toHex8String(true);}
if(format==="hex8"){formattedString=this.toHex8String();}
if(format==="name"){formattedString=this.toName();}
if(format==="hsl"){formattedString=this.toHslString();}
if(format==="hsv"){formattedString=this.toHsvString();}
return formattedString||this.toHexString();},clone:function clone(){return tinycolor(this.toString());},_applyModification:function _applyModification(fn,args){var color=fn.apply(null,[this].concat([].slice.call(args)));this._r=color._r;this._g=color._g;this._b=color._b;this.setAlpha(color._a);return this;},lighten:function lighten(){return this._applyModification(_lighten,arguments);},brighten:function brighten(){return this._applyModification(_brighten,arguments);},darken:function darken(){return this._applyModification(_darken,arguments);},desaturate:function desaturate(){return this._applyModification(_desaturate,arguments);},saturate:function saturate(){return this._applyModification(_saturate,arguments);},greyscale:function greyscale(){return this._applyModification(_greyscale,arguments);},spin:function spin(){return this._applyModification(_spin,arguments);},_applyCombination:function _applyCombination(fn,args){return fn.apply(null,[this].concat([].slice.call(args)));},analogous:function analogous(){return this._applyCombination(_analogous,arguments);},complement:function complement(){return this._applyCombination(_complement,arguments);},monochromatic:function monochromatic(){return this._applyCombination(_monochromatic,arguments);},splitcomplement:function splitcomplement(){return this._applyCombination(_splitcomplement,arguments);},triad:function triad(){return this._applyCombination(polyad,[3]);},tetrad:function tetrad(){return this._applyCombination(polyad,[4]);}};tinycolor.fromRatio=function(color,opts){if(_typeof(color)=="object"){var newColor={};for(var i in color){if(color.hasOwnProperty(i)){if(i==="a"){newColor[i]=color[i];}else{newColor[i]=convertToPercentage(color[i]);}}}
color=newColor;}
return tinycolor(color,opts);};function inputToRGB(color){var rgb={r:0,g:0,b:0};var a=1;var s=null;var v=null;var l=null;var ok=false;var format=false;if(typeof color=="string"){color=stringInputToObject(color);}
if(_typeof(color)=="object"){if(isValidCSSUnit(color.r)&&isValidCSSUnit(color.g)&&isValidCSSUnit(color.b)){rgb=rgbToRgb(color.r,color.g,color.b);ok=true;format=String(color.r).substr(-1)==="%"?"prgb":"rgb";}else if(isValidCSSUnit(color.h)&&isValidCSSUnit(color.s)&&isValidCSSUnit(color.v)){s=convertToPercentage(color.s);v=convertToPercentage(color.v);rgb=hsvToRgb(color.h,s,v);ok=true;format="hsv";}else if(isValidCSSUnit(color.h)&&isValidCSSUnit(color.s)&&isValidCSSUnit(color.l)){s=convertToPercentage(color.s);l=convertToPercentage(color.l);rgb=hslToRgb(color.h,s,l);ok=true;format="hsl";}
if(color.hasOwnProperty("a")){a=color.a;}}
a=boundAlpha(a);return{ok:ok,format:color.format||format,r:Math.min(255,Math.max(rgb.r,0)),g:Math.min(255,Math.max(rgb.g,0)),b:Math.min(255,Math.max(rgb.b,0)),a:a};}
function rgbToRgb(r,g,b){return{r:bound01(r,255)*255,g:bound01(g,255)*255,b:bound01(b,255)*255};}
function rgbToHsl(r,g,b){r=bound01(r,255);g=bound01(g,255);b=bound01(b,255);var max=Math.max(r,g,b),min=Math.min(r,g,b);var h,s,l=(max+min)/2;if(max==min){h=s=0;}else{var d=max-min;s=l>0.5?d/(2-max-min):d/(max+min);switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;}
h/=6;}
return{h:h,s:s,l:l};}
function hslToRgb(h,s,l){var r,g,b;h=bound01(h,360);s=bound01(s,100);l=bound01(l,100);function hue2rgb(p,q,t){if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p;}
if(s===0){r=g=b=l;}else{var q=l<0.5?l*(1+s):l+s-l*s;var p=2*l-q;r=hue2rgb(p,q,h+1/3);g=hue2rgb(p,q,h);b=hue2rgb(p,q,h-1/3);}
return{r:r*255,g:g*255,b:b*255};}
function rgbToHsv(r,g,b){r=bound01(r,255);g=bound01(g,255);b=bound01(b,255);var max=Math.max(r,g,b),min=Math.min(r,g,b);var h,s,v=max;var d=max-min;s=max===0?0:d/max;if(max==min){h=0;}else{switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;}
h/=6;}
return{h:h,s:s,v:v};}
function hsvToRgb(h,s,v){h=bound01(h,360)*6;s=bound01(s,100);v=bound01(v,100);var i=Math.floor(h),f=h-i,p=v*(1-s),q=v*(1-f*s),t=v*(1-(1-f)*s),mod=i%6,r=[v,q,p,p,t,v][mod],g=[t,v,v,q,p,p][mod],b=[p,p,t,v,v,q][mod];return{r:r*255,g:g*255,b:b*255};}
function rgbToHex(r,g,b,allow3Char){var hex=[pad2(Math.round(r).toString(16)),pad2(Math.round(g).toString(16)),pad2(Math.round(b).toString(16))];if(allow3Char&&hex[0].charAt(0)==hex[0].charAt(1)&&hex[1].charAt(0)==hex[1].charAt(1)&&hex[2].charAt(0)==hex[2].charAt(1)){return hex[0].charAt(0)+hex[1].charAt(0)+hex[2].charAt(0);}
return hex.join("");}
function rgbaToHex(r,g,b,a,allow4Char){var hex=[pad2(Math.round(r).toString(16)),pad2(Math.round(g).toString(16)),pad2(Math.round(b).toString(16)),pad2(convertDecimalToHex(a))];if(allow4Char&&hex[0].charAt(0)==hex[0].charAt(1)&&hex[1].charAt(0)==hex[1].charAt(1)&&hex[2].charAt(0)==hex[2].charAt(1)&&hex[3].charAt(0)==hex[3].charAt(1)){return hex[0].charAt(0)+hex[1].charAt(0)+hex[2].charAt(0)+hex[3].charAt(0);}
return hex.join("");}
function rgbaToArgbHex(r,g,b,a){var hex=[pad2(convertDecimalToHex(a)),pad2(Math.round(r).toString(16)),pad2(Math.round(g).toString(16)),pad2(Math.round(b).toString(16))];return hex.join("");}
tinycolor.equals=function(color1,color2){if(!color1||!color2)return false;return tinycolor(color1).toRgbString()==tinycolor(color2).toRgbString();};tinycolor.random=function(){return tinycolor.fromRatio({r:Math.random(),g:Math.random(),b:Math.random()});};function _desaturate(color,amount){amount=amount===0?0:amount||10;var hsl=tinycolor(color).toHsl();hsl.s-=amount/100;hsl.s=clamp01(hsl.s);return tinycolor(hsl);}
function _saturate(color,amount){amount=amount===0?0:amount||10;var hsl=tinycolor(color).toHsl();hsl.s+=amount/100;hsl.s=clamp01(hsl.s);return tinycolor(hsl);}
function _greyscale(color){return tinycolor(color).desaturate(100);}
function _lighten(color,amount){amount=amount===0?0:amount||10;var hsl=tinycolor(color).toHsl();hsl.l+=amount/100;hsl.l=clamp01(hsl.l);return tinycolor(hsl);}
function _brighten(color,amount){amount=amount===0?0:amount||10;var rgb=tinycolor(color).toRgb();rgb.r=Math.max(0,Math.min(255,rgb.r-Math.round(255*-(amount/100))));rgb.g=Math.max(0,Math.min(255,rgb.g-Math.round(255*-(amount/100))));rgb.b=Math.max(0,Math.min(255,rgb.b-Math.round(255*-(amount/100))));return tinycolor(rgb);}
function _darken(color,amount){amount=amount===0?0:amount||10;var hsl=tinycolor(color).toHsl();hsl.l-=amount/100;hsl.l=clamp01(hsl.l);return tinycolor(hsl);}
function _spin(color,amount){var hsl=tinycolor(color).toHsl();var hue=(hsl.h+amount)%360;hsl.h=hue<0?360+hue:hue;return tinycolor(hsl);}
function _complement(color){var hsl=tinycolor(color).toHsl();hsl.h=(hsl.h+180)%360;return tinycolor(hsl);}
function polyad(color,number){if(isNaN(number)||number<=0){throw new Error("Argument to polyad must be a positive number");}
var hsl=tinycolor(color).toHsl();var result=[tinycolor(color)];var step=360/number;for(var i=1;i<number;i++){result.push(tinycolor({h:(hsl.h+i*step)%360,s:hsl.s,l:hsl.l}));}
return result;}
function _splitcomplement(color){var hsl=tinycolor(color).toHsl();var h=hsl.h;return[tinycolor(color),tinycolor({h:(h+72)%360,s:hsl.s,l:hsl.l}),tinycolor({h:(h+216)%360,s:hsl.s,l:hsl.l})];}
function _analogous(color,results,slices){results=results||6;slices=slices||30;var hsl=tinycolor(color).toHsl();var part=360/slices;var ret=[tinycolor(color)];for(hsl.h=(hsl.h-(part*results>>1)+720)%360;--results;){hsl.h=(hsl.h+part)%360;ret.push(tinycolor(hsl));}
return ret;}
function _monochromatic(color,results){results=results||6;var hsv=tinycolor(color).toHsv();var h=hsv.h,s=hsv.s,v=hsv.v;var ret=[];var modification=1/results;while(results--){ret.push(tinycolor({h:h,s:s,v:v}));v=(v+modification)%1;}
return ret;}
tinycolor.mix=function(color1,color2,amount){amount=amount===0?0:amount||50;var rgb1=tinycolor(color1).toRgb();var rgb2=tinycolor(color2).toRgb();var p=amount/100;var rgba={r:(rgb2.r-rgb1.r)*p+rgb1.r,g:(rgb2.g-rgb1.g)*p+rgb1.g,b:(rgb2.b-rgb1.b)*p+rgb1.b,a:(rgb2.a-rgb1.a)*p+rgb1.a};return tinycolor(rgba);};tinycolor.readability=function(color1,color2){var c1=tinycolor(color1);var c2=tinycolor(color2);return(Math.max(c1.getLuminance(),c2.getLuminance())+0.05)/(Math.min(c1.getLuminance(),c2.getLuminance())+0.05);};tinycolor.isReadable=function(color1,color2,wcag2){var readability=tinycolor.readability(color1,color2);var wcag2Parms,out;out=false;wcag2Parms=validateWCAG2Parms(wcag2);switch(wcag2Parms.level+wcag2Parms.size){case "AAsmall":case "AAAlarge":out=readability>=4.5;break;case "AAlarge":out=readability>=3;break;case "AAAsmall":out=readability>=7;break;}
return out;};tinycolor.mostReadable=function(baseColor,colorList,args){var bestColor=null;var bestScore=0;var readability;var includeFallbackColors,level,size;args=args||{};includeFallbackColors=args.includeFallbackColors;level=args.level;size=args.size;for(var i=0;i<colorList.length;i++){readability=tinycolor.readability(baseColor,colorList[i]);if(readability>bestScore){bestScore=readability;bestColor=tinycolor(colorList[i]);}}
if(tinycolor.isReadable(baseColor,bestColor,{level:level,size:size})||!includeFallbackColors){return bestColor;}else{args.includeFallbackColors=false;return tinycolor.mostReadable(baseColor,["#fff","#000"],args);}};var names=tinycolor.names={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"0ff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000",blanchedalmond:"ffebcd",blue:"00f",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",burntsienna:"ea7e5d",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"0ff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkgrey:"a9a9a9",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkslategrey:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dimgrey:"696969",dodgerblue:"1e90ff",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"f0f",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",grey:"808080",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgray:"d3d3d3",lightgreen:"90ee90",lightgrey:"d3d3d3",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslategray:"789",lightslategrey:"789",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"0f0",limegreen:"32cd32",linen:"faf0e6",magenta:"f0f",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370db",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"db7093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",rebeccapurple:"663399",red:"f00",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",slategrey:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",wheat:"f5deb3",white:"fff",whitesmoke:"f5f5f5",yellow:"ff0",yellowgreen:"9acd32"};var hexNames=tinycolor.hexNames=flip(names);function flip(o){var flipped={};for(var i in o){if(o.hasOwnProperty(i)){flipped[o[i]]=i;}}
return flipped;}
function boundAlpha(a){a=parseFloat(a);if(isNaN(a)||a<0||a>1){a=1;}
return a;}
function bound01(n,max){if(isOnePointZero(n))n="100%";var processPercent=isPercentage(n);n=Math.min(max,Math.max(0,parseFloat(n)));if(processPercent){n=parseInt(n*max,10)/100;}
if(Math.abs(n-max)<0.000001){return 1;}
return n%max/parseFloat(max);}
function clamp01(val){return Math.min(1,Math.max(0,val));}
function parseIntFromHex(val){return parseInt(val,16);}
function isOnePointZero(n){return typeof n=="string"&&n.indexOf(".")!=-1&&parseFloat(n)===1;}
function isPercentage(n){return typeof n==="string"&&n.indexOf("%")!=-1;}
function pad2(c){return c.length==1?"0"+c:""+c;}
function convertToPercentage(n){if(n<=1){n=n*100+"%";}
return n;}
function convertDecimalToHex(d){return Math.round(parseFloat(d)*255).toString(16);}
function convertHexToDecimal(h){return parseIntFromHex(h)/255;}
var matchers=function(){var CSS_INTEGER="[-\\+]?\\d+%?";var CSS_NUMBER="[-\\+]?\\d*\\.\\d+%?";var CSS_UNIT="(?:"+CSS_NUMBER+")|(?:"+CSS_INTEGER+")";var PERMISSIVE_MATCH3="[\\s|\\(]+("+CSS_UNIT+")[,|\\s]+("+CSS_UNIT+")[,|\\s]+("+CSS_UNIT+")\\s*\\)?";var PERMISSIVE_MATCH4="[\\s|\\(]+("+CSS_UNIT+")[,|\\s]+("+CSS_UNIT+")[,|\\s]+("+CSS_UNIT+")[,|\\s]+("+CSS_UNIT+")\\s*\\)?";return{CSS_UNIT:new RegExp(CSS_UNIT),rgb:new RegExp("rgb"+PERMISSIVE_MATCH3),rgba:new RegExp("rgba"+PERMISSIVE_MATCH4),hsl:new RegExp("hsl"+PERMISSIVE_MATCH3),hsla:new RegExp("hsla"+PERMISSIVE_MATCH4),hsv:new RegExp("hsv"+PERMISSIVE_MATCH3),hsva:new RegExp("hsva"+PERMISSIVE_MATCH4),hex3:/^#?([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,hex6:/^#?([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/,hex4:/^#?([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,hex8:/^#?([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/};}();function isValidCSSUnit(color){return!!matchers.CSS_UNIT.exec(color);}
function stringInputToObject(color){color=color.replace(trimLeft,"").replace(trimRight,"").toLowerCase();var named=false;if(names[color]){color=names[color];named=true;}else if(color=="transparent"){return{r:0,g:0,b:0,a:0,format:"name"};}
var match;if(match=matchers.rgb.exec(color)){return{r:match[1],g:match[2],b:match[3]};}
if(match=matchers.rgba.exec(color)){return{r:match[1],g:match[2],b:match[3],a:match[4]};}
if(match=matchers.hsl.exec(color)){return{h:match[1],s:match[2],l:match[3]};}
if(match=matchers.hsla.exec(color)){return{h:match[1],s:match[2],l:match[3],a:match[4]};}
if(match=matchers.hsv.exec(color)){return{h:match[1],s:match[2],v:match[3]};}
if(match=matchers.hsva.exec(color)){return{h:match[1],s:match[2],v:match[3],a:match[4]};}
if(match=matchers.hex8.exec(color)){return{r:parseIntFromHex(match[1]),g:parseIntFromHex(match[2]),b:parseIntFromHex(match[3]),a:convertHexToDecimal(match[4]),format:named?"name":"hex8"};}
if(match=matchers.hex6.exec(color)){return{r:parseIntFromHex(match[1]),g:parseIntFromHex(match[2]),b:parseIntFromHex(match[3]),format:named?"name":"hex"};}
if(match=matchers.hex4.exec(color)){return{r:parseIntFromHex(match[1]+""+match[1]),g:parseIntFromHex(match[2]+""+match[2]),b:parseIntFromHex(match[3]+""+match[3]),a:convertHexToDecimal(match[4]+""+match[4]),format:named?"name":"hex8"};}
if(match=matchers.hex3.exec(color)){return{r:parseIntFromHex(match[1]+""+match[1]),g:parseIntFromHex(match[2]+""+match[2]),b:parseIntFromHex(match[3]+""+match[3]),format:named?"name":"hex"};}
return false;}
function validateWCAG2Parms(parms){var level,size;parms=parms||{level:"AA",size:"small"};level=(parms.level||"AA").toUpperCase();size=(parms.size||"small").toLowerCase();if(level!=="AA"&&level!=="AAA"){level="AA";}
if(size!=="small"&&size!=="large"){size="small";}
return{level:level,size:size};}
const DEFAULT_BLACK='#000000';const TRANSPARENT_RGBA='rgba(255, 255, 255, 0)';const getPathAttr=(path,attr)=>{const value=path.getAttribute(attr);if(value){return value;}
if(!path.parentElement){return;}
return getPathAttr(path.parentElement,attr);};const getPathFill=path=>{var _path$style;let val=getPathAttr(path,'fill');if(val==='none'){return{type:'color',color:TRANSPARENT_RGBA};}
if(!val&&(_path$style=path.style)!==null&&_path$style!==void 0&&_path$style.fill&&path.style.fill.includes('rgb')){val=tinycolor(path.style.fill).toHex8String();}
return{type:'color',color:val||DEFAULT_BLACK};};const getAttributesFromSVG=path=>{var _getPathAttr;return{path:path.getAttribute('d')||'',stroke:getPathAttr(path,'stroke'),opacity:Number((_getPathAttr=getPathAttr(path,'fill-opacity'))!==null&&_getPathAttr!==void 0?_getPathAttr:1),strokeWidth:Number(getPathAttr(path,'stroke-width'))||0,lineCap:getPathAttr(path,'stroke-linecap'),lineJoin:getPathAttr(path,'stroke-linejoin'),fill:getPathFill(path),id:generateId()};};async function loadSvgForLayer(url){const response=await fetch(url);const blobSvg=await response.blob();const data=await new Promise(resolve=>{const object=document.createElement('object');object.type='image/svg+xml';object.title='fake';object.addEventListener('load',()=>{const doc=object.contentDocument;const paths=Array.from((doc===null||doc===void 0?void 0:doc.querySelectorAll('path'))||[]);document.body.removeChild(object);resolve({paths:paths.map(getAttributesFromSVG)});},false);object.data=URL.createObjectURL(blobSvg);object.classList.add('visually-hidden');document.body.append(object);});return data;}
const parseFill=fill=>{if(!fill){return{type:'color',color:DEFAULT_BLACK};}
if(fill.type==='color'){return{type:'color',color:fill.color};}else if(['linear','conic','radial'].includes(fill.type)){return{type:'gradient',gradient:{...fill,colors:fill.colors.map(stop=>({percentage:stop.percentage,value:stop.color}))}};}else if(fill.type==='texture'){return{location:fill.resource_url,type:'photo',id:fill.resource_id};}
return{type:'color',color:DEFAULT_BLACK};};const parseShape=async(shape,resources,existingData)=>{if(!existingData.replay.context.layers[shape.uuid]){const canvasGroup=Object.values(existingData.replay.context.layers).find(layer=>layer.mediaType===LayerMediaType.canvasGroup);existingData.replay.context.layers[shape.uuid]=createReplayShapeLayer({name:'shape',mediaType:LayerMediaType.shape,uuid:shape.uuid,props:{width:1,height:1,shape:{id:resources[shape.settings.shape].id,location:resources[shape.settings.shape].location,type:'svg'}}});canvasGroup.props.children.value.push(shape.uuid);}
const replayLayer=existingData.replay.context.layers[shape.uuid];const props=replayLayer.props;const settings=shape.settings;props.opacity.value=createReplayLayerProperty(settings.opacity).value;props.blendMode.value=parseBlendMode$1(settings.blendmode);if(settings.stroke){props.stroke.value=parseStroke$1(settings.stroke);}
if(settings.shadow){props.shadow.value=parseShadow$1(settings.shadow);}
if(settings.adjust.length){props.paths.value=settings.adjust.map(adjust=>({...adjust,d:adjust.path,stroke:adjust.stroke?parseStroke$1(adjust.stroke):null,fill:parsePattern$1(adjust.fill)}));}else if(resources[settings.shape].location){const pathData=(await loadSvgForLayer(resources[settings.shape].location)).paths;props.paths.value=pathData.map(path=>({d:path.path,stroke:null,id:generateId(),fill:parseFill(path.fill)}));}
if(settings.rect.w){props.width.value=createReplayLayerProperty(settings.rect.w/existingData.replay.context.layout.width).value;}
if(settings.rect.h){props.height.value=createReplayLayerProperty(settings.rect.h/existingData.replay.context.layout.height).value;}
props.shape.value={id:resources[settings.shape].id,location:resources[settings.shape].location,type:'svg'};};const loadImage=async url=>new Promise((resolve,reject)=>{const image=new Image();image.crossOrigin='anonymous';image.onload=()=>{image.onload=null;resolve(image);};image.onerror=reject;image.src=url;});var loadImage$1=withScheduler(loadImage);const findMediaTypeUntilCanvasGroup=(replay,replayLayer,mediaType)=>{const parentReplayLayer=findReplayLayerParent(replay,replayLayer.uuid);if(parentReplayLayer){if(parentReplayLayer.mediaType===LayerMediaType.canvasGroup){return null;}
if(parentReplayLayer.mediaType===mediaType){return parentReplayLayer;}
return findMediaTypeUntilCanvasGroup(replay,parentReplayLayer,mediaType);}
return null;};const parseImage=async(photo,resources,existingData)=>{try{var _settings$mask;if(!existingData.replay.context.layers[photo.uuid]){var _existingData$selecte;const canvasGroupUuid=Object.values(existingData.replay.context.layers).find(layer=>layer.mediaType===LayerMediaType.canvasGroup).uuid;const location=resources[photo.settings.photo].location;const newReplayLayer=createReplayImageLayer({name:'image',mediaType:LayerMediaType.photo,uuid:photo.uuid,props:{image:{id:resources[photo.settings.photo].id,location,type:'photo',width:1,height:1}}});(_existingData$selecte=existingData.selectedLayerIds)===null||_existingData$selecte===void 0||_existingData$selecte.push(photo.uuid);const{width,height}=await loadImage$1(location);if(width&&height){const scale=Math.min(existingData.replay.context.layout.width/width,existingData.replay.context.layout.height/height)*0.9;newReplayLayer.props.scaleX.value=scale;newReplayLayer.props.scaleY.value=scale;}
existingData.replay.context.layers[photo.uuid]=newReplayLayer;existingData.replay.context.layers[canvasGroupUuid].props.children.value.push(photo.uuid);}
const replayLayer=existingData.replay.context.layers[photo.uuid];const props=replayLayer.props;const settings=photo.settings;if(props.image.value.location!==resources[settings.photo].location){const renderedWidth=props.image.value.width*props.scaleX.value;const renderedHeight=props.image.value.height*props.scaleY.value;const{width,height}=await loadImage$1(resources[settings.photo].location);props.scaleX.value=renderedWidth/width;props.scaleY.value=renderedHeight/height;props.image.value={...props.image.value,location:resources[settings.photo].location,type:'photo'};props.image.meta.originalUrl=resources[settings.photo].location;}
props.opacity.value=createReplayLayerProperty(settings.opacity).value;props.blendMode.value=parseBlendMode$1(settings.blendmode);if(settings.stroke){props.stroke.value=parseStroke$1(settings.stroke);}
if(settings.shadow){props.shadow.value=parseShadow$1(settings.shadow);}
if((_settings$mask=settings.mask)!==null&&_settings$mask!==void 0&&_settings$mask.mask){if(!findMediaTypeUntilCanvasGroup(existingData.replay,replayLayer,LayerMediaType.maskGroup)){const parentLayer=findReplayLayerParent(existingData.replay,replayLayer.uuid);const maskGroup=createReplayGroupLayer({name:'mask',mediaType:LayerMediaType.maskGroup,props:{width:props.image.value.width*props.scaleX.value/existingData.replay.context.layout.width,height:props.image.value.height*props.scaleY.value/existingData.replay.context.layout.height}});const uuid=generateId();const maskImageLayer=createReplayImageLayer({name:'mask-image',mediaType:LayerMediaType.mask,uuid,props:{blendMode:'xor',image:{id:uuid,type:'photo',location:'',width:1,height:1}}});maskGroup.props.children.value.push(maskImageLayer.uuid,replayLayer.uuid);parentLayer.props.children.value=parentLayer.props.children.value.map(childUuid=>childUuid===replayLayer.uuid?maskGroup.uuid:childUuid);}
const maskGroupReplayLayer=findMediaTypeUntilCanvasGroup(existingData.replay,replayLayer,LayerMediaType.maskGroup);const layers=findReplayLayerChildren(existingData.replay,maskGroupReplayLayer.uuid);const maskLayer=layers.find(layer=>layer.mediaType===LayerMediaType.mask);if(maskLayer){maskLayer.props.image.value={...maskLayer.props.image.value,location:resources[settings.mask.mask].location};}}else{const maskGroupReplayLayer=findMediaTypeUntilCanvasGroup(existingData.replay,replayLayer,LayerMediaType.maskGroup);if(maskGroupReplayLayer){const maskLayerId=maskGroupReplayLayer.props.children.value.find(id=>existingData.replay.context.layers[id].mediaType===LayerMediaType.mask);if(maskLayerId){existingData.replay=removeReplayLayer(existingData.replay,maskLayerId);}
existingData.replay=unGroupReplayLayers(existingData.replay,maskGroupReplayLayer.uuid);existingData.replay=removeReplayLayer(existingData.replay,maskGroupReplayLayer.uuid);}}}catch(err){console.log(err,'>>>>>>>>>>>>>>>>>>>>>Error parseing image');}};const blackListedLayers=[LayerMediaType.backgroundColor,LayerMediaType.collageCellGroup,LayerMediaType.canvasGroup,LayerMediaType.backgroundImage,LayerMediaType.collageGroup,LayerMediaType.collageCell,LayerMediaType.cropGroup,LayerMediaType.crop,LayerMediaType.overlay,LayerMediaType.overlayGroup];const isBlackListedLayer=layer=>blackListedLayers.includes(layer.mediaType);const isSimpleLayer=layer=>isReplayShapeLayer(layer)||isReplayVideoLayer(layer)||isReplayTextLayer(layer)||isReplayImageLayer(layer);const DEFAULT_FONT_SIZE=64;const toReplayV3FromV2=async options=>{const existingData=window.v8CurrentPayload;if(isConfirmAction(options.data)&&existingData.replay){var _options$data$payload,_options$data$payload2,_options$data$payload3,_options$data$payload4,_options$data$payload5;const asyncFunctions=[];existingData.selectedLayerIds=existingData.selectedLayerIds||[];const resources=options.data.payload.resources||{};const allLayersIds=[];(_options$data$payload=options.data.payload.videos)===null||_options$data$payload===void 0||_options$data$payload.forEach(video=>{allLayersIds.push(video.uuid);if(!existingData.replay.context.layers[video.uuid]){var _existingData$selecte;const canvasGroupUuid=Object.values(existingData.replay.context.layers).find(layer=>layer.mediaType===LayerMediaType.canvasGroup).uuid;existingData.replay.context.layers[video.uuid]=createReplayVideoLayer({uuid:video.uuid,name:'video',mediaType:LayerMediaType.video,props:{volume:1,trimEnd:1,trimStart:0,video:{},blendMode:parseBlendMode$1(video.settings.blendmode)}});existingData.replay.context.layers[canvasGroupUuid].props.children.value.push(video.uuid);(_existingData$selecte=existingData.selectedLayerIds)===null||_existingData$selecte===void 0||_existingData$selecte.push(video.uuid);}
const replayLayer=existingData.replay.context.layers[video.uuid];const props=replayLayer.props;const settings=video.settings;props.duration.value=createReplayLayerProperty(video.settings.duration).value;props.startTime.value=createReplayLayerProperty(settings.start_time).value;props.trimStart.value=createReplayLayerProperty(settings.trim_start).value;props.trimEnd.value=createReplayLayerProperty(settings.trim_end).value;props.volume.value=createReplayLayerProperty(settings.volume).value;props.video.value={...props.video.value,location:resources[settings.video].location,type:'video'};props.blendMode.value=parseBlendMode$1(settings.blendmode);});(_options$data$payload2=options.data.payload.images)===null||_options$data$payload2===void 0||_options$data$payload2.forEach(photo=>{allLayersIds.push(photo.uuid);asyncFunctions.push(parseImage(photo,resources,existingData));});(_options$data$payload3=options.data.payload.stickers)===null||_options$data$payload3===void 0||_options$data$payload3.forEach(sticker=>{allLayersIds.push(sticker.uuid);const resource=resources[sticker.settings.sticker];if(resource.type==='photo'){asyncFunctions.push(parseImage({...sticker,settings:{...sticker.settings,photo:sticker.settings.sticker}},resources,existingData));}else{asyncFunctions.push(parseShape({...sticker,settings:{...sticker.settings,shape:sticker.settings.sticker}},resources,existingData));}});(_options$data$payload4=options.data.payload.texts)===null||_options$data$payload4===void 0||_options$data$payload4.forEach(text=>{var _props$ranges$value$;allLayersIds.push(text.uuid);if(!existingData.replay.context.layers[text.uuid]){var _existingData$selecte2;const canvasGroupUuid=Object.values(existingData.replay.context.layers).find(layer=>layer.mediaType===LayerMediaType.canvasGroup).uuid;existingData.replay.context.layers[text.uuid]=createReplayTextLayer({uuid:text.uuid,name:'text',mediaType:LayerMediaType.text,props:{ranges:[],width:1,font:{}}});existingData.replay.context.layers[canvasGroupUuid].props.children.value.push(text.uuid);(_existingData$selecte2=existingData.selectedLayerIds)===null||_existingData$selecte2===void 0||_existingData$selecte2.push(text.uuid);}
const replayLayer=existingData.replay.context.layers[text.uuid];const props=replayLayer.props;const settings=text.settings;props.alignment.value=settings.alignment==='justify'?'center':settings.alignment;props.letterSpacing.value=createReplayLayerProperty(settings.letter_spacing).value;props.lineHeight.value=createReplayLayerProperty(settings.line_spacing).value;props.bend.value=createReplayLayerProperty(settings.bend).value;if(settings.stroke){props.stroke.value=parseStroke$1(settings.stroke);}
if(settings.shadow){props.shadow.value=parseShadow$1(settings.shadow);}
props.opacity.value=createReplayLayerProperty(settings.opacity).value;props.blendMode.value=parseBlendMode$1(settings.blendmode);props.ranges.value=[{...props.ranges.value[0],text:settings.text,fill:parsePattern$1(settings.fill),format:settings.format,fontSize:((_props$ranges$value$=props.ranges.value[0])===null||_props$ranges$value$===void 0?void 0:_props$ranges$value$.fontSize)||DEFAULT_FONT_SIZE}];if(settings.font){props.font.value={...resources[settings.font],id:text.meta.fontFamily||resources[settings.font].id,type:'font'};}});(_options$data$payload5=options.data.payload.shapes)===null||_options$data$payload5===void 0||_options$data$payload5.forEach(shape=>{allLayersIds.push(shape.uuid);asyncFunctions.push(parseShape(shape,resources,existingData));});if(options.data.payload.artboard){existingData.replay.context.layout.width=options.data.payload.artboard.width;existingData.replay.context.layout.height=options.data.payload.artboard.height;}
Object.values(existingData.replay.context.layers).forEach(layer=>{if(!isBlackListedLayer(layer)&&isSimpleLayer(layer)&&!allLayersIds.includes(layer.uuid)&&layer.mediaType!==LayerMediaType.mask){existingData.replay=removeReplayLayer(existingData.replay,layer.uuid);}});try{await Promise.all(asyncFunctions);}catch(err){console.log(err,'>>>>>>>>>>parsing error promise.all');}
return{...options,data:{...options.data,payload:{...options.data.payload,replay:existingData.replay}}};}
return options;};const jsonToStringJson=json=>Object.entries(json).reduce((acc,_ref)=>{let[key,value]=_ref;acc[key]=JSON.stringify(value);return acc;},{});const parseBlendMode=blendMode=>{return blendMode==='source-over'?'normal':blendMode.replaceAll('-','_');};const parseTransform=layer=>{if(isReplayAudioLayer(layer))return defaultTransform;return{...defaultTransform,position:{x:layer.props.x.value,y:layer.props.y.value},scale:layer.props.scaleX.value,rotation:layer.props.rotation.value,aspect_scale:layer.props.scaleX.value/layer.props.scaleY.value,flipped:{horizontal:layer.props.scaleX.value<0,vertical:layer.props.scaleY.value<0}};};const parseStroke=stroke=>{if(!stroke)return;return{pattern:parsePattern(stroke.pattern),width:stroke.width,linecap:stroke.linecap,linejoin:stroke.linejoin};};const parseShadow=shadow=>{if(!shadow)return;const{color,offset,blur}=shadow;return{color,offset_x:offset.x,offset_y:offset.y,blur};};const parsePattern=pattern=>{var _pattern$gradient,_pattern$texture;const gradient=(_pattern$gradient=pattern.gradient)!==null&&_pattern$gradient!==void 0&&_pattern$gradient.colors?pattern.gradient:undefined;const v6Gradient=gradient&&{colors:gradient.colors.map(_ref2=>{let{value}=_ref2;return value;}),angle:gradient.angle};return{solid:pattern.color,gradient:v6Gradient,texture:(_pattern$texture=pattern.texture)===null||_pattern$texture===void 0?void 0:_pattern$texture.location,opacity:1};};function fromReplayV3toV2(options){if(!isConfirmAction(options.data)&&!isBootstrapAction(options.data))return options;const replay=options.data.payload.replay;const replayLayers=replay===null||replay===void 0?void 0:replay.context.layers;const resources={};const v2Layers=replayLayers&&Object.values(replayLayers).reduce((acc,layer)=>{if(isBlackListedLayer(layer))return acc;if(isReplayVideoLayer(layer)){const resourceId=layer.props.video.value.id;resources[resourceId]={...layer.props.video.value,source:'picsart'};const v2Layer={settings:{video:resourceId,visible:true,start_time:layer.props.startTime.value,duration:layer.props.duration.value,trim_start:layer.props.trimStart.value,trim_end:layer.props.trimEnd.value,transform:parseTransform(layer),volume:layer.props.volume.value,blendmode:parseBlendMode(layer.props.blendMode.value)},meta:jsonToStringJson(layer.meta),type:'video',uuid:layer.uuid};acc.videos.push(v2Layer);}else if(isReplayImageLayer(layer)&&layer.mediaType!==LayerMediaType.mask){var _props;const isSticker=layer.mediaType==='STICKER';const resourceId=layer.props.image.value.id;resources[resourceId]={...layer.props.image.value,source:'picsart'};const parentReplayLayer=findReplayLayerParent(replay,layer.uuid);const isInCropGroup=parentReplayLayer.meta.type==='CROP_GROUP';const possibleMaskGroup=isInCropGroup?findReplayLayerParent(replay,parentReplayLayer.uuid):parentReplayLayer;const isInMaskGroup=possibleMaskGroup.meta.type==='IMAGE_MASK_GROUP';const maskLayerId=isInMaskGroup&&possibleMaskGroup.props.children.value.find(childId=>replay.context.layers[childId].meta.type==='MASK');const maskLayer=!!maskLayerId&&replayLayers[maskLayerId];if(maskLayer){resources[maskLayer.props.image.value.id]={...maskLayer.props.image.value,source:'picsart'};}
const props={transform:parseTransform(layer),opacity:layer.props.opacity.value,blendmode:parseBlendMode(layer.props.blendMode.value),mask:{...defaultMask,mask:(_props=maskLayer.props)===null||_props===void 0?void 0:_props.image.value.id},stroke:parseStroke(layer.props.stroke.value),shadow:parseShadow(layer.props.shadow.value)};if(isSticker){const v2Layer={settings:{sticker:resourceId,...props},meta:jsonToStringJson(layer.meta),type:'sticker',uuid:layer.uuid};acc.stickers.push(v2Layer);return acc;}
const v2Layer={settings:{photo:resourceId,...props},meta:jsonToStringJson(layer.meta),type:isSticker?'sticker':'photo',uuid:layer.uuid};acc.images.push(v2Layer);}else if(isReplayTextLayer(layer)){const resourceId=layer.props.font.value.id;resources[resourceId]={...layer.props.font.value,source:'picsart'};const v2Layer={settings:{text:layer.props.ranges.value.map(_ref3=>{let{text}=_ref3;return text;}).join(''),lines:[],font:resourceId,alignment:layer.props.alignment.value,letter_spacing:layer.props.letterSpacing.value,line_spacing:layer.props.lineHeight.value,bend:layer.props.bend.value,stroke:parseStroke(layer.props.stroke.value),shadow:parseShadow(layer.props.shadow.value),fill:parsePattern(layer.props.ranges.value[0].fill),opacity:layer.props.opacity.value,transform:parseTransform(layer),blendmode:parseBlendMode(layer.props.blendMode.value),format:layer.props.ranges.value[0].format,perspective_points:[]},meta:jsonToStringJson(layer.meta),type:'text',uuid:layer.uuid};acc.texts.push(v2Layer);}else if(isReplayShapeLayer(layer)){const resourceId=layer.props.shape.value.id;resources[resourceId]={...layer.props.shape.value,source:'picsart'};const v2Layer={settings:{shape:resourceId,transform:parseTransform(layer),opacity:layer.props.opacity.value,blendmode:parseBlendMode(layer.props.blendMode.value),drawing_mode:'fill_inside',stroke:parseStroke(layer.props.stroke.value),shadow:parseShadow(layer.props.shadow.value),adjust:layer.props.paths.value.map(adjust=>({...adjust,path:adjust.d,fill:parsePattern(adjust.fill),stroke:parseStroke(adjust.stroke)})),rect:{w:layer.props.width.value*(replay===null||replay===void 0?void 0:replay.context.layout.width),h:layer.props.height.value*(replay===null||replay===void 0?void 0:replay.context.layout.height),x:0,y:0}},meta:jsonToStringJson(layer.meta),type:'shape',uuid:layer.uuid};acc.shapes.push(v2Layer);}
return acc;},{videos:[],images:[],stickers:[],texts:[],shapes:[]});return{...options,data:{...options.data,payload:{...options.data.payload,...v2Layers,resources,artboard:{width:replay===null||replay===void 0?void 0:replay.context.layout.width,height:replay===null||replay===void 0?void 0:replay.context.layout.height}}}};}
function runV7ToV8Migrations(options){return migrate(options,{migrateFrom:'v7',migrateTo:'v8'},[exportFiles,toReplayV3FromV2]);}
function runV8ToV7Migrations(options){return migrate(options,{migrateFrom:'v8',migrateTo:'v7'},[receiveMessages,generateResultImageResponse,fromReplayV3toV2]);}
const allMigrations=new Map([['v4',4],['v5',5],['v6',6],['v7',7],['v8',8]]);function validateMigrationVersions(source,target,direction){const sourceIndex=allMigrations.get(source);const targetIndex=allMigrations.get(target);if(!targetIndex||!sourceIndex){console.error("Invalid migration version: ".concat(source===undefined?target:source,". Migrations have been skipped."));return false;}
if(direction==='up'&&sourceIndex>targetIndex||direction==='down'&&sourceIndex<targetIndex){console.error("Error: Executing the ".concat(direction," migration from ").concat(source," to ").concat(target," is not supported. Please update the platform version. Migrations have been skipped."));return false;}
return true;}
const runMigrationsUp=asyncPipeline(runV4ToV5Migrations,runV5ToV6Migrations,runV6ToV7Migrations,runV7ToV8Migrations);const runMigrationsDown=asyncPipeline(runV8ToV7Migrations,runV7ToV6Migrations,runV6ToV5Migrations,runV5ToV4Migrations);const runPrivateAPIMigrations=async(data,_ref)=>{let{send,platformVersion,sdkVersion}=_ref;const currentVersion=!send?platformVersion:sdkVersion;const targetVersion=!send?sdkVersion:platformVersion;if(!validateMigrationVersions(currentVersion,targetVersion,send?'up':'down')){return data;}
if(!send){return(await runMigrationsDown({data,currentVersion,targetVersion})).data;}
if(send){return(await runMigrationsUp({data,currentVersion,targetVersion})).data;}
return data;};window.runPrivateAPIMigrations=runPrivateAPIMigrations;})();